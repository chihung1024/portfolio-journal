<html>
  <head>
    <title>Stock Portfolio</title>
    <style>
      body {
        font-family: sans-serif;
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      th, td {
        border: 1px solid #ccc;
        padding: 8px;
        text-align: left;
      }
      th {
        background-color: #f2f2f2;
      }
    </style>
  </head>
  <body>
    <h1>Stock Portfolio</h1>
    
    <h2>Holdings</h2>
    <table id="holdings-table">
      <thead>
        <tr>
          <th>Stock</th>
          <th>Shares</th>
          <th>Price</th>
          <th>Market Value</th>
          <th>Cost Basis</th>
          <th>Gain/Loss</th>
        </tr>
      </thead>
      <tbody>
      </tbody>
    </table>

    <h2>Transactions</h2>
    <table id="transactions-table">
      <thead>
        <tr>
          <th>Date</th>
          <th>Stock</th>
          <th>Type</th>
          <th>Shares</th>
          <th>Price</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody>
      </tbody>
    </table>

    <script src="/__/firebase/8.10.0/firebase-app.js"></script>
    <script src="/__/firebase/8.10.0/firebase-firestore.js"></script>
    <script src="/__/firebase/init.js"></script>
    <script>
      const db = firebase.firestore();

      // Holdings Table
      const holdingsTable = document.querySelector('#holdings-table tbody');
      db.collection('transactions').onSnapshot(snapshot => {
        const holdings = {};
        snapshot.forEach(doc => {
          const transaction = doc.data();
          const stockId = transaction.stock_id;
          if (!holdings[stockId]) {
            holdings[stockId] = {
              shares: 0,
              cost: 0
            };
          }
          if (transaction.type === 'buy') {
            holdings[stockId].shares += transaction.shares_adjusted;
            holdings[stockId].cost += transaction.price_original * transaction.shares_original;
          } else if (transaction.type === 'sell') {
            holdings[stockId].shares -= transaction.shares_adjusted;
            holdings[stockId].cost -= transaction.price_original * transaction.shares_original;
          }
        });

        holdingsTable.innerHTML = '';
        for (const stockId in holdings) {
          const holding = holdings[stockId];
          db.collection('stocks').doc(stockId).get().then(stockDoc => {
            const stock = stockDoc.data();
            const marketValue = holding.shares * stock.price;
            const gainLoss = marketValue - holding.cost;
            const row = holdingsTable.insertRow();
            row.innerHTML = `
              <td>${stockId}</td>
              <td>${holding.shares.toFixed(2)}</td>
              <td>${stock.price.toFixed(2)}</td>
              <td>${marketValue.toFixed(2)}</td>
              <td>${holding.cost.toFixed(2)}</td>
              <td>${gainLoss.toFixed(2)}</td>
            `;
          });
        }
      });

      // Transactions Table
      const transactionsTable = document.querySelector('#transactions-table tbody');
      db.collection('transactions').orderBy('date', 'desc').onSnapshot(snapshot => {
        transactionsTable.innerHTML = '';
        snapshot.forEach(doc => {
          const transaction = doc.data();
          const row = transactionsTable.insertRow();
          row.innerHTML = `
            <td>${transaction.date}</td>
            <td>${transaction.stock_id}</td>
            <td>${transaction.type}</td>
            <td>${transaction.shares_original}</td>
            <td>${transaction.price_original.toFixed(2)}</td>
            <td>${(transaction.shares_original * transaction.price_original).toFixed(2)}</td>
          `;
        });
      });
    </script>
  </body>
</html>
