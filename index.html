<html>
  <head>
    <title>Stock Portfolio</title>
    <style>
      body {
        font-family: sans-serif;
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      th, td {
        border: 1px solid #ccc;
        padding: 8px;
        text-align: left;
      }
      th {
        background-color: #f2f2f2;
      }
    </style>
  </head>
  <body>
    <h1>Stock Portfolio</h1>
    
    <div>
      <label for="currency-select">Display Currency:</label>
      <select id="currency-select"></select>
    </div>

    <h2>Holdings</h2>
    <table id="holdings-table">
      <thead>
        <tr>
          <th>Stock</th>
          <th>Shares</th>
          <th>Price</th>
          <th>Market Value</th>
          <th>Cost Basis</th>
          <th>Gain/Loss</th>
        </tr>
      </thead>
      <tbody>
      </tbody>
    </table>

    <h2>Transactions</h2>
    <table id="transactions-table">
      <thead>
        <tr>
          <th>Date</th>
          <th>Stock</th>
          <th>Type</th>
          <th>Shares</th>
          <th>Price</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody>
      </tbody>
    </table>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script>
      // PASTE YOUR FIREBASE CONFIG HERE
      const firebaseConfig = {
        apiKey: "YOUR_API_KEY",
        authDomain: "YOUR_AUTH_DOMAIN",
        projectId: "YOUR_PROJECT_ID",
        storageBucket: "YOUR_STORAGE_BUCKET",
        messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
        appId: "YOUR_APP_ID"
      };

      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();

      const currencySelect = document.getElementById('currency-select');
      let rates = {};
      let selectedCurrency = 'USD';

      function formatCurrency(amount) {
        return new Intl.NumberFormat('en-US', { style: 'currency', currency: selectedCurrency }).format(amount);
      }

      function render() {
        renderHoldings();
        renderTransactions();
      }

      db.collection('rates').doc('latest').onSnapshot(doc => {
        rates = doc.data();
        currencySelect.innerHTML = Object.keys(rates).sort().map(currency => `<option value="${currency}">${currency}</option>`).join('');
        currencySelect.value = selectedCurrency;
        render();
      });

      currencySelect.addEventListener('change', (e) => {
        selectedCurrency = e.target.value;
        render();
      });

      function renderHoldings() {
        const holdingsTable = document.querySelector('#holdings-table tbody');
        db.collection('transactions').onSnapshot(snapshot => {
          const holdings = {};
          snapshot.forEach(doc => {
            const transaction = doc.data();
            const stockId = transaction.stock_id;
            if (!holdings[stockId]) {
              holdings[stockId] = {
                shares: 0,
                cost: 0
              };
            }
            if (transaction.type === 'buy') {
              holdings[stockId].shares += transaction.shares_adjusted;
              holdings[stockId].cost += transaction.price_original * transaction.shares_original;
            } else if (transaction.type === 'sell') {
              holdings[stockId].shares -= transaction.shares_adjusted;
              holdings[stockId].cost -= transaction.price_original * transaction.shares_original;
            }
          });

          holdingsTable.innerHTML = '';
          for (const stockId in holdings) {
            const holding = holdings[stockId];
            db.collection('stocks').doc(stockId).get().then(stockDoc => {
              const stock = stockDoc.data();
              const rate = rates[selectedCurrency] / rates[stock.currency];
              const marketValue = holding.shares * stock.price * rate;
              const costBasis = holding.cost * rate;
              const gainLoss = marketValue - costBasis;
              const row = holdingsTable.insertRow();
              row.innerHTML = `
                <td>${stockId}</td>
                <td>${holding.shares.toFixed(2)}</td>
                <td>${formatCurrency(stock.price * rate)}</td>
                <td>${formatCurrency(marketValue)}</td>
                <td>${formatCurrency(costBasis)}</td>
                <td>${formatCurrency(gainLoss)}</td>
              `;
            });
          }
        });
      }

      function renderTransactions() {
        const transactionsTable = document.querySelector('#transactions-table tbody');
        db.collection('transactions').orderBy('date', 'desc').onSnapshot(snapshot => {
          transactionsTable.innerHTML = '';
          snapshot.forEach(doc => {
            const transaction = doc.data();
            const rate = rates[selectedCurrency] / rates[transaction.currency_original];
            const total = transaction.shares_original * transaction.price_original * rate;
            const row = transactionsTable.insertRow();
            row.innerHTML = `
              <td>${transaction.date}</td>
              <td>${transaction.stock_id}</td>
              <td>${transaction.type}</td>
              <td>${transaction.shares_original}</td>
              <td>${formatCurrency(transaction.price_original * rate)}</td>
              <td>${formatCurrency(total)}</td>
            `;
          });
        });
      }
    </script>
  </body>
</html>
