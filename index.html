<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>股票交易紀錄與資產分析系統 (最終修正版)</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 ApexCharts 圖表庫 -->
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <!-- 引入 Lucide Icons 圖示庫 -->
    <script src="https://cdn.jsdelivr.net/npm/lucide@0.378.0/dist/umd/lucide.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; background-color: #f0f2f5; }
        .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); transition: all 0.3s ease-in-out; }
        .card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); }
        .btn { transition: all 0.2s ease-in-out; }
        .btn:hover { transform: scale(1.05); }
        .modal-backdrop { background-color: rgba(0,0,0,0.5); transition: opacity 0.3s ease; }
        .optional-field { display: none; }
    </style>
</head>
<body class="text-gray-800">

    <div id="app" class="min-h-screen">
        <!-- Notification Area -->
        <div id="notification-area" class="fixed top-5 right-5 z-50"></div>

        <!-- Header -->
        <header class="bg-white shadow-md sticky top-0 z-20">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <i data-lucide="line-chart" class="text-indigo-600 h-8 w-8"></i>
                    <h1 class="text-2xl font-bold text-gray-800">交易紀錄與資產分析 (最終修正版)</h1>
                </div>
                <div id="auth-status-display" class="flex items-center space-x-4 text-xs text-gray-500 text-right">
                    <div id="user-info" class="hidden">
                        <span id="auth-status">已連線</span>
                        <p id="user-id" class="truncate max-w-[150px] sm:max-w-xs"></p>
                    </div>
                    <button id="logout-btn" class="hidden btn bg-red-500 text-white font-bold py-1 px-3 rounded-lg shadow-md hover:bg-red-600">登出</button>
                </div>
            </div>
        </header>
        <div id="auth-container" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 hidden">
            <div class="max-w-md mx-auto bg-white rounded-lg shadow-md p-8">
                <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">登入或註冊</h2>
                <form id="auth-form">
                    <div class="mb-4">
                        <label for="email" class="block text-sm font-medium text-gray-700 mb-1">電子郵件</label>
                        <input type="email" id="email" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required>
                    </div>
                    <div class="mb-6">
                        <label for="password" class="block text-sm font-medium text-gray-700 mb-1">密碼</label>
                        <input type="password" id="password" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required>
                    </div>
                    <div class="flex items-center justify-between space-x-4">
                        <button type="button" id="login-btn" class="w-full btn bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700">登入</button>
                        <button type="button" id="register-btn" class="w-full btn bg-gray-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-gray-700">註冊</button>
                    </div>
                </form>
            </div>
        </div>
        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Loading Spinner -->
            <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-40">
                <div class="flex flex-col items-center text-center p-4">
                    <svg id="loading-spinner-icon" class="animate-spin h-10 w-10 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    <p id="loading-text" class="mt-4 text-lg font-medium text-gray-700">正在從雲端同步資料...</p>
                </div>
            </div>

            <!-- Dashboard Stats -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
                <div class="card p-5 flex flex-col justify-between"><div class="flex items-center justify-between"><h3 class="text-sm font-medium text-gray-500">總資產 (TWD)</h3><i data-lucide="wallet" class="h-6 w-6 text-gray-400"></i></div><p id="total-assets" class="text-3xl font-bold text-gray-800 mt-2">0</p></div>
                <div class="card p-5 flex flex-col justify-between"><div class="flex items-center justify-between"><h3 class="text-sm font-medium text-gray-500">未實現損益 (TWD)</h3><i data-lucide="trending-up" class="h-6 w-6 text-gray-400"></i></div><p id="unrealized-pl" class="text-3xl font-bold text-gray-800 mt-2">0</p></div>
                <div class="card p-5 flex flex-col justify-between"><div class="flex items-center justify-between"><h3 class="text-sm font-medium text-gray-500">已實現損益 (TWD)</h3><i data-lucide="dollar-sign" class="h-6 w-6 text-gray-400"></i></div><p id="realized-pl" class="text-3xl font-bold text-gray-800 mt-2">0</p></div>
                <div class="card p-5 flex flex-col justify-between"><div class="flex items-center justify-between"><h3 class="text-sm font-medium text-gray-500">總報酬率</h3><i data-lucide="percent" class="h-6 w-6 text-gray-400"></i></div><p id="total-return" class="text-3xl font-bold text-gray-800 mt-2">0.00%</p></div>
                <div class="card p-5 flex flex-col justify-between"><div class="flex items-center justify-between"><h3 class="text-sm font-medium text-gray-500">XIRR 年化報酬率</h3><i data-lucide="calendar-check" class="h-6 w-6 text-gray-400"></i></div><p id="xirr-value" class="text-3xl font-bold text-gray-800 mt-2">0.00%</p></div>
            </div>

            <!-- Holdings and Transactions -->
            <div class="card p-6 mb-8">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4">
                    <div class="sm:flex sm:items-center sm:space-x-4"><h2 class="text-xl font-bold text-gray-800">投資組合</h2><div class="mt-2 sm:mt-0 border-b sm:border-b-0 sm:border-l border-gray-200 sm:pl-4"><nav class="-mb-px flex space-x-6" id="tabs"><a href="#" data-tab="holdings" class="tab-item whitespace-nowrap border-b-2 font-medium text-sm border-indigo-500 text-indigo-600">持股一覽</a><a href="#" data-tab="transactions" class="tab-item whitespace-nowrap border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">交易紀錄</a><a href="#" data-tab="splits" class="tab-item whitespace-nowrap border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">拆股事件</a></nav></div></div>
                    <div class="flex space-x-2">
                        <button id="manage-splits-btn" class="btn bg-gray-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-gray-700 flex items-center space-x-2"><i data-lucide="git-merge" class="h-5 w-5"></i><span>管理拆股</span></button>
                        <button id="add-transaction-btn" class="btn bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 flex items-center space-x-2"><i data-lucide="plus-circle" class="h-5 w-5"></i><span>新增交易</span></button>
                    </div>
                </div>
                <div id="holdings-tab" class="tab-content overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">代碼</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">股數</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">平均成本(原幣)</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">總成本(TWD)</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">現價(原幣)</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">市值(TWD)</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">未實現損益(TWD)</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">報酬率</th></tr></thead><tbody id="holdings-table-body" class="bg-white divide-y divide-gray-200"></tbody></table></div>
                <div id="transactions-tab" class="tab-content overflow-x-auto hidden"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">日期</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">代碼</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">類型</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">股數</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">價格(原幣)</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">總金額(TWD)</th><th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th></tr></thead><tbody id="transactions-table-body" class="bg-white divide-y divide-gray-200"></tbody></table></div>
                <div id="splits-tab" class="tab-content overflow-x-auto hidden"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">日期</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">代碼</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">比例</th><th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th></tr></thead><tbody id="splits-table-body" class="bg-white divide-y divide-gray-200"></tbody></table></div>
            </div>

            <!-- Asset Growth Chart -->
            <div class="card p-6"><h3 class="text-lg font-semibold text-gray-800 mb-4">資產成長曲線 (TWD)</h3><div id="asset-chart"></div></div>
            <div class="card p-6 mt-8"><h3 class="text-lg font-semibold text-gray-800 mb-4">時間加權報酬走勢圖 (%)</h3><div id="twr-chart"></div></div>
        </main>

        <!-- Modals -->
        <div id="transaction-modal" class="fixed inset-0 z-30 overflow-y-auto hidden"><div class="flex items-center justify-center min-h-screen"><div class="fixed inset-0 modal-backdrop" id="modal-backdrop-trans"></div><div class="bg-white rounded-lg shadow-xl p-8 z-40 w-full max-w-md mx-4"><h3 id="modal-title" class="text-2xl font-bold mb-6 text-gray-800">新增交易紀錄</h3><form id="transaction-form"><input type="hidden" id="transaction-id"><div class="mb-4"><label for="transaction-date" class="block text-sm font-medium text-gray-700 mb-1">日期</label><input type="date" id="transaction-date" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required></div><div class="mb-4"><label for="stock-symbol" class="block text-sm font-medium text-gray-700 mb-1">股票代碼</label><input type="text" id="stock-symbol" placeholder="例如: AAPL, 2330.TW" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required></div><div class="mb-4"><label class="block text-sm font-medium text-gray-700 mb-1">交易類型</label><div class="flex space-x-4"><label class="flex items-center"><input type="radio" name="transaction-type" value="buy" class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500" checked><span class="ml-2 text-gray-700">買入</span></label><label class="flex items-center"><input type="radio" name="transaction-type" value="sell" class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500"><span class="ml-2 text-gray-700">賣出</span></label></div></div><div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4"><div><label for="quantity" class="block text-sm font-medium text-gray-700 mb-1">股數</label><input type="number" step="any" id="quantity" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required></div><div><label for="price" class="block text-sm font-medium text-gray-700 mb-1">價格 (原幣)</label><input type="number" step="any" id="price" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required></div></div><div class="mb-4"><label for="currency" class="block text-sm font-medium text-gray-700 mb-1">幣別</label><select id="currency" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"><option value="USD">USD</option><option value="TWD">TWD</option></select></div>
                <div id="exchange-rate-field" class="space-y-4 mb-4 p-4 border border-gray-200 rounded-md optional-field">
                    <label for="exchange-rate" class="block text-sm font-medium text-gray-700 mb-1">手動匯率 (選填)</label>
                    <input type="number" step="any" id="exchange-rate" placeholder="留空則自動抓取" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div id="total-cost-field" class="space-y-4 mb-4 p-4 border border-gray-200 rounded-md">
                    <label for="total-cost" class="block text-sm font-medium text-gray-700 mb-1">總成本 (含費用, 原幣, 選填)</label>
                    <input type="number" step="any" id="total-cost" placeholder="留空則自動計算 (股數*價格)" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div class="flex justify-end space-x-4 mt-6"><button type="button" id="cancel-btn" class="btn bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">取消</button><button type="submit" id="save-btn" class="btn bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700">儲存</button></div></form></div></div></div>
        <div id="split-modal" class="fixed inset-0 z-30 overflow-y-auto hidden"><div class="flex items-center justify-center min-h-screen"><div class="fixed inset-0 modal-backdrop" id="modal-backdrop-split"></div><div class="bg-white rounded-lg shadow-xl p-8 z-40 w-full max-w-md mx-4"><h3 class="text-2xl font-bold mb-6 text-gray-800">新增拆股/合股事件</h3><form id="split-form"><input type="hidden" id="split-id"><div class="mb-4"><label for="split-date" class="block text-sm font-medium text-gray-700 mb-1">日期</label><input type="date" id="split-date" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required></div><div class="mb-4"><label for="split-symbol" class="block text-sm font-medium text-gray-700 mb-1">股票代碼</label><input type="text" id="split-symbol" placeholder="例如: AAPL, 2330.TW" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required></div><div class="mb-4"><label for="split-ratio" class="block text-sm font-medium text-gray-700 mb-1">比例</label><input type="number" step="any" id="split-ratio" placeholder="1拆10, 輸入10; 10合1, 輸入0.1" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required></div><div class="flex justify-end space-x-4 mt-6"><button type="button" id="cancel-split-btn" class="btn bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">取消</button><button type="submit" id="save-split-btn" class="btn bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700">儲存</button></div></form></div></div></div>
        <div id="confirm-modal" class="fixed inset-0 z-50 overflow-y-auto hidden"><div class="flex items-center justify-center min-h-screen"><div class="fixed inset-0 modal-backdrop"></div><div class="bg-white rounded-lg shadow-xl p-8 z-50 w-full max-w-sm mx-4"><h3 id="confirm-title" class="text-lg font-semibold mb-4 text-gray-800">確認操作</h3><p id="confirm-message" class="text-gray-600 mb-6">您確定要執行此操作嗎？</p><div class="flex justify-end space-x-4"><button id="confirm-cancel-btn" class="btn bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">取消</button><button id="confirm-ok-btn" class="btn bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-red-700">確定</button></div></div></div></div>
    </div>

<script type="module">
    // --- Firebase SDK ---
    import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, collection, doc, addDoc, onSnapshot, updateDoc, deleteDoc, query, orderBy, getDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // =================================================================================
    // === Firebase 設定 ===
    // =================================================================================
    const firebaseConfig = {
        apiKey: "AIzaSyAlymQXtutAG8UY48-TehVU70jD9RmCiBE",
        authDomain: "trading-journal-4922c.firebaseapp.com",
        projectId: "trading-journal-4922c",
        storageBucket: "trading-journal-4922c.appspot.com",
        messagingSenderId: "50863752247",
        appId: "1:50863752247:web:766eaa892d2c8d28bb6bb2"
    };
    // =================================================================================

    // --- 全域變數 ---
    let db, auth;
    let transactions = [];
    let userSplits = [];
    let holdings = {};
    let chart;
    let twrChart; // 新增 TWR 圖表的全域變數
    let userId;
    let realizedPLFromBackend = 0;
    let overallReturnRateFromBackend = 0;
    let xirrFromBackend = 0;
    
    let transactionsUnsubscribe = null;
    let splitsUnsubscribe = null;
    let historyUnsubscribe = null;
    let holdingsUnsubscribe = null;
    let confirmCallback = null;

    const exchangeRateCache = new Map();
    let dataLoaded = { transactions: false, holdings: false, splits: false };

    // --- 主程式入口 ---
    document.addEventListener('DOMContentLoaded', () => {
        initialize();
    });

    // --- 核心函式 ---
    async function initialize() {
        console.log("Initializing application...");
        if (!firebaseConfig.projectId) {
            showLoadingError("設定錯誤！", "您的 firebaseConfig 中缺少 projectId。");
            return;
        }

        try {
            const app = !getApps().length ? initializeApp(firebaseConfig) : getApp();
            auth = getAuth(app);
            db = getFirestore(app);
            setupEventListeners();
            initializeChart();
            initializeTwrChart(); // 初始化 TWR 圖表
            lucide.createIcons();
            handleAuthentication();
        } catch (error) {
            console.error("Firebase 初始化失敗:", error);
            showLoadingError("Firebase 初始化失敗！", "請檢查 firebaseConfig 是否正確。");
        }
    }

    function handleAuthentication() {
        onAuthStateChanged(auth, (user) => {
            const mainContent = document.querySelector('main');
            const authContainer = document.getElementById('auth-container');
            const userInfo = document.getElementById('user-info');
            const logoutBtn = document.getElementById('logout-btn');

            if (user) {
                userId = user.uid;
                document.getElementById('user-id').textContent = `使用者: ${user.email}`;
                authContainer.classList.add('hidden');
                mainContent.classList.remove('hidden');
                userInfo.classList.remove('hidden');
                logoutBtn.classList.remove('hidden');
                setupDataListeners();
            } else {
                userId = null;
                if (transactionsUnsubscribe) transactionsUnsubscribe();
                if (splitsUnsubscribe) splitsUnsubscribe();
                if (historyUnsubscribe) historyUnsubscribe();
                if (holdingsUnsubscribe) holdingsUnsubscribe();
                authContainer.classList.remove('hidden');
                mainContent.classList.add('hidden');
                userInfo.classList.add('hidden');
                logoutBtn.classList.add('hidden');
                document.getElementById('loading-overlay').style.display = 'none';
            }
        });
    }

    function setupEventListeners() {
        document.getElementById('add-transaction-btn').addEventListener('click', () => openModal());
        document.getElementById('cancel-btn').addEventListener('click', closeModal);
        document.getElementById('modal-backdrop-trans').addEventListener('click', closeModal);
        document.getElementById('transaction-form').addEventListener('submit', handleFormSubmit);
        document.getElementById('manage-splits-btn').addEventListener('click', openSplitModal);
        document.getElementById('cancel-split-btn').addEventListener('click', closeSplitModal);
        document.getElementById('modal-backdrop-split').addEventListener('click', closeSplitModal);
        document.getElementById('split-form').addEventListener('submit', handleSplitFormSubmit);
        document.getElementById('tabs').addEventListener('click', (e) => { e.preventDefault(); if (e.target.matches('.tab-item')) { switchTab(e.target.dataset.tab); } });
        document.getElementById('confirm-cancel-btn').addEventListener('click', hideConfirm);
        document.getElementById('confirm-ok-btn').addEventListener('click', () => { if (confirmCallback) { confirmCallback(); } hideConfirm(); });
        document.getElementById('currency').addEventListener('change', toggleOptionalFields);
        document.getElementById('login-btn').addEventListener('click', handleLogin);
        document.getElementById('register-btn').addEventListener('click', handleRegister);
        document.getElementById('logout-btn').addEventListener('click', handleLogout);
    }
    
    async function handleRegister() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        if (!email || !password) { showNotification('error', '請輸入電子郵件和密碼。'); return; }
        try {
            await createUserWithEmailAndPassword(auth, email, password);
            showNotification('success', '註冊成功！已自動登入。');
        } catch (error) { console.error("註冊失敗:", error); showNotification('error', `註冊失敗: ${error.message}`); }
    }

    async function handleLogin() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        if (!email || !password) { showNotification('error', '請輸入電子郵件和密碼。'); return; }
        try {
            await signInWithEmailAndPassword(auth, email, password);
            showNotification('success', '登入成功！');
        } catch (error) { console.error("登入失敗:", error); showNotification('error', `登入失敗: ${error.message}`); }
    }

    async function handleLogout() {
        try {
            await signOut(auth);
            transactions = []; userSplits = []; holdings = {};
            renderAll();
            chart?.updateSeries([{ data: [] }]);
            twrChart?.updateSeries([{ data: [] }]);
            showNotification('info', '您已成功登出。');
        } catch (error) { console.error("登出失敗:", error); showNotification('error', `登出失敗: ${error.message}`); }
    }

    function toggleOptionalFields() {
        const currency = document.getElementById('currency').value;
        document.getElementById('exchange-rate-field').style.display = (currency === 'USD') ? 'block' : 'none';
    }

    function setupDataListeners() {
        if (!userId) return;

        if (transactionsUnsubscribe) transactionsUnsubscribe();
        if (splitsUnsubscribe) splitsUnsubscribe();
        if (historyUnsubscribe) historyUnsubscribe();
        if (holdingsUnsubscribe) holdingsUnsubscribe();
        
        dataLoaded = { transactions: false, holdings: false, splits: false };
        transactions = []; userSplits = []; holdings = {};

        document.getElementById('loading-overlay').style.display = 'flex';

        const transactionsCol = collection(db, 'users', userId, 'transactions');
        const tq = query(transactionsCol, orderBy("date", "asc"));
        transactionsUnsubscribe = onSnapshot(tq, (snapshot) => {
            transactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            dataLoaded.transactions = true;
            updateExchangeRateCache().then(() => renderAll());
        }, (error) => console.error("讀取交易紀錄失敗:", error));

        const splitsCol = collection(db, 'users', userId, 'splits');
        const sq = query(splitsCol, orderBy("date", "asc"));
        splitsUnsubscribe = onSnapshot(sq, (snapshot) => {
            userSplits = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            dataLoaded.splits = true;
            renderAll();
        }, (error) => console.error("讀取拆股事件失敗:", error));
        
        const holdingsDocRef = doc(db, 'users', userId, 'user_data', 'current_holdings');
        holdingsUnsubscribe = onSnapshot(holdingsDocRef, (docSnap) => {
            if (docSnap.exists()) {
                const data = docSnap.data();
                holdings = data.holdings || {};
                realizedPLFromBackend = data.totalRealizedPL || 0;
                overallReturnRateFromBackend = data.overallReturnRateTotal ?? data.overallReturnRate ?? 0;
                xirrFromBackend = data.xirr || 0;
            } else {
                holdings = {}; realizedPLFromBackend = 0; overallReturnRateFromBackend = 0; xirrFromBackend = 0;
            }
            dataLoaded.holdings = true;
            renderAll();
        }, (error) => console.error("讀取持股資料失敗:", error));

        const historyDocRef = doc(db, 'users', userId, 'user_data', 'portfolio_history');
        historyUnsubscribe = onSnapshot(historyDocRef, (docSnap) => {
            console.log("--- 偵錯日誌：步驟 A ---");
            if (docSnap.exists()) {
                const historyData = docSnap.data().history;
                console.log("從 Firestore 收到的 historyData:", historyData);
                updateAssetChart(historyData);
                updateTwrChart(historyData);
            } else {
                console.log("history 文件不存在。");
                updateAssetChart({});
                updateTwrChart({});
            }
        }, (error) => { console.error("讀取資產歷史失敗:", error); });
    }

    async function renderAll() {
        if (!dataLoaded.transactions || !dataLoaded.holdings || !dataLoaded.splits) return;
        renderHoldingsTable();
        renderTransactionsTable();
        renderSplitsTable();
        updateDashboard();
        document.getElementById('loading-overlay').style.display = 'none';
        showNotification('success', '雲端資料同步完成！');
    }
    
    function renderHoldingsTable() { /* ... 內容不變 ... */ }
    async function renderTransactionsTable() { /* ... 內容不變 ... */ }
    function renderSplitsTable() { /* ... 內容不變 ... */ }
    function updateDashboard() { /* ... 內容不變 ... */ }

    function initializeChart() {
        const options = { chart: { type: 'area', height: 350, zoom: { enabled: true }, toolbar: { show: true } }, series: [{ name: '總資產', data: [] }], xaxis: { type: 'datetime', labels: { datetimeUTC: false, format: 'yy/MM/dd' } }, yaxis: { labels: { formatter: (value) => { return formatNumber(value, 0) } } }, dataLabels: { enabled: false }, stroke: { curve: 'smooth', width: 2 }, fill: { type: 'gradient', gradient: { shadeIntensity: 1, opacityFrom: 0.7, opacityTo: 0.3, stops: [0, 90, 100] } }, tooltip: { x: { format: 'yyyy/MM/dd' }, y: { formatter: (value) => { return formatNumber(value) } } }, colors: ['#4f46e5'] };
        chart = new ApexCharts(document.querySelector("#asset-chart"), options);
        chart.render();
    }

    function initializeTwrChart() {
        const options = { chart: { type: 'area', height: 350, zoom: { enabled: true }, toolbar: { show: true } }, series: [{ name: '時間加權報酬', data: [] }], xaxis: { type: 'datetime', labels: { datetimeUTC: false, format: 'yy/MM/dd' } }, yaxis: { labels: { formatter: (value) => { return value.toFixed(2) + '%' } } }, dataLabels: { enabled: false }, stroke: { curve: 'smooth', width: 2 }, fill: { type: 'gradient', gradient: { shadeIntensity: 1, opacityFrom: 0.7, opacityTo: 0.3, stops: [0, 90, 100] } }, tooltip: { x: { format: 'yyyy/MM/dd' }, y: { formatter: (value) => { return value.toFixed(2) + '%' } } }, colors: ['#059669'] };
        twrChart = new ApexCharts(document.querySelector("#twr-chart"), options);
        twrChart.render();
    }

    function updateAssetChart(portfolioHistory) {
        console.log("--- 偵錯日誌：步驟 B (資產圖表) ---");
        console.log("updateAssetChart 接收到的資料:", portfolioHistory);
        if (!chart || !portfolioHistory || Object.keys(portfolioHistory).length === 0) {
            console.log("資產圖表：資料為空或圖表未初始化，清空圖表。");
            if(chart) chart.updateSeries([{ data: [] }]);
            return;
        }
        try {
            const chartData = Object.entries(portfolioHistory)
                .sort((a, b) => new Date(a[0]) - new Date(b[0]))
                .map(([date, value]) => {
                    const marketVal = (typeof value === 'object' && value !== null && value.marketValue !== undefined) 
                        ? value.marketValue 
                        : (typeof value === 'number' ? value : 0);
                    return [new Date(date).getTime(), marketVal];
                });
            console.log("準備渲染到資產圖表的最終數據:", chartData);
            chart.updateSeries([{ data: chartData }]);
        } catch (e) { console.error("updateAssetChart 內部發生錯誤:", e); }
    }

    function updateTwrChart(portfolioHistory) {
        console.log("--- 偵錯日誌：步驟 C (TWR圖表) ---");
        console.log("updateTwrChart 接收到的資料:", portfolioHistory);
        if (!twrChart || !portfolioHistory || Object.keys(portfolioHistory).length === 0) {
            console.log("TWR圖表：資料為空或圖表未初始化，清空圖表。");
            if(twrChart) twrChart.updateSeries([{ data: [] }]);
            return;
        }
        try {
            const chartData = Object.entries(portfolioHistory)
                .sort((a, b) => new Date(a[0]) - new Date(b[0]))
                .map(([date, value]) => {
                    const twrIndex = (typeof value === 'object' && value !== null && value.twr !== undefined) 
                        ? value.twr 
                        : 1; 
                    return [new Date(date).getTime(), (twrIndex - 1) * 100];
                });
            console.log("準備渲染到TWR圖表的最終數據:", chartData);
            twrChart.updateSeries([{ data: chartData }]);
        } catch (e) { console.error("updateTwrChart 內部發生錯誤:", e); }
    }
    
    async function updateExchangeRateCache() { /* ... 內容不變 ... */ }
    function findNearestAvailableRate(history, targetDateStr) { /* ... 內容不變 ... */ }
    async function handleFormSubmit(e) { /* ... 內容不變 ... */ }
    async function handleSplitFormSubmit(e) { /* ... 內容不變 ... */ }
    async function handleDelete(e) { /* ... 內容不變 ... */ }
    async function handleDeleteSplit(e) { /* ... 內容不變 ... */ }
    function handleEdit(e) { /* ... 內容不變 ... */ }
    function openModal(isEdit = false, transaction = null) { /* ... 內容不變 ... */ }
    function openSplitModal() { /* ... 內容不變 ... */ }
    function closeModal() { document.getElementById('transaction-modal').classList.add('hidden'); }
    function closeSplitModal() { document.getElementById('split-modal').classList.add('hidden'); }
    function hideConfirm() { confirmCallback = null; document.getElementById('confirm-modal').classList.add('hidden'); }
    function isTwStock(symbol) { if (!symbol) return false; const upperSymbol = symbol.toUpperCase(); return upperSymbol.endsWith('.TW') || upperSymbol.endsWith('.TWO'); }
    function formatNumber(value, decimals = 2) { const num = Number(value); if (isNaN(num)) return '0.00'; return num.toLocaleString('en-US', { minimumFractionDigits: decimals, maximumFractionDigits: decimals }); }
    function showNotification(type, message) { const area = document.getElementById('notification-area'); const color = type === 'success' ? 'bg-green-500' : (type === 'info' ? 'bg-blue-500' : 'bg-red-500'); const icon = type === 'success' ? 'check-circle' : (type === 'info' ? 'info' : 'alert-circle'); const notification = document.createElement('div'); notification.className = `flex items-center ${color} text-white text-sm font-bold px-4 py-3 rounded-md shadow-lg mb-2`; notification.innerHTML = `<i data-lucide="${icon}" class="w-5 h-5 mr-2"></i><p>${message}</p>`; area.appendChild(notification); lucide.createIcons({nodes: [notification.querySelector('i')]}); setTimeout(() => { notification.style.transition = 'opacity 0.5s ease'; notification.style.opacity = '0'; setTimeout(() => notification.remove(), 500); }, 5000); }
    function showConfirm(message, callback) { document.getElementById('confirm-message').textContent = message; confirmCallback = callback; document.getElementById('confirm-modal').classList.remove('hidden'); }
    function showLoadingError(title, message, link = null) { const loadingSpinner = document.getElementById('loading-spinner-icon'); if (loadingSpinner) loadingSpinner.style.display = 'none'; const loadingText = document.getElementById('loading-text'); let linkHtml = link ? `<a href="${link}" target="_blank" class="mt-4 inline-block bg-blue-500 text-white font-bold py-2 px-4 rounded hover:bg-blue-700">前往 Firebase 控制台</a>` : ''; loadingText.innerHTML = `<p class="text-red-600 font-bold text-xl">${title}</p><p class="mt-2 text-gray-600">${message}</p>${linkHtml}`; }
    function switchTab(tabName) { document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden')); document.getElementById(`${tabName}-tab`).classList.remove('hidden'); document.querySelectorAll('.tab-item').forEach(el => { el.classList.remove('border-indigo-500', 'text-indigo-600'); el.classList.add('border-transparent', 'text-gray-500'); }); const activeTab = document.querySelector(`[data-tab="${tabName}"]`); activeTab.classList.add('border-indigo-500', 'text-indigo-600'); activeTab.classList.remove('border-transparent', 'text-gray-500'); }

</script>
</body>
</html>
