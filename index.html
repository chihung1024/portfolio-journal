<html>
  <head>
    <title>Stock Portfolio</title>
    <style>
      body {
        font-family: sans-serif;
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      th, td {
        border: 1px solid #ccc;
        padding: 8px;
        text-align: left;
      }
      th {
        background-color: #f2f2f2;
      }
    </style>
  </head>
  <body>
    <h1>Stock Portfolio</h1>
    
    <div>
      <label for="currency-select">Display Currency:</label>
      <select id="currency-select"></select>
    </div>

    <h2>Holdings</h2>
    <table id="holdings-table">
      <thead>
        <tr>
          <th>Stock</th>
          <th>Shares</th>
          <th>Price</th>
          <th>Market Value</th>
          <th>Cost Basis</th>
          <th>Gain/Loss</th>
        </tr>
      </thead>
      <tbody>
      </tbody>
    </table>

    <h2>Transactions</h2>
    <table id="transactions-table">
      <thead>
        <tr>
          <th>Date</th>
          <th>Stock</th>
          <th>Type</th>
          <th>Shares</th>
          <th>Price</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody>
      </tbody>
    </table>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script>
      // PASTE YOUR FIREBASE CONFIG HERE
const firebaseConfig = {
  apiKey: "AIzaSyAlymQXtutAG8UY48-TehVU70jD9RmCiBE",
  authDomain: "trading-journal-4922c.firebaseapp.com",
  projectId: "trading-journal-4922c",
  storageBucket: "trading-journal-4922c.firebasestorage.app",
  messagingSenderId: "50863752247",
  appId: "1:50863752247:web:766eaa892d2c8d28bb6bb2"
};

      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();

      const currencySelect = document.getElementById('currency-select');
      let rates = {};
      let selectedCurrency = 'USD';

      function formatCurrency(amount) {
        return new Intl.NumberFormat('en-US', { style: 'currency', currency: selectedCurrency }).format(amount);
      }

      function render() {
        renderHoldings();
        renderTransactions();
      }

      db.collection('rates').doc('latest').onSnapshot(doc => {
        const data = doc.data();
        if (data) {
          rates = data;
          const currencies = Object.keys(rates).sort();
          currencySelect.innerHTML = currencies.map(c => `<option value="${c}">${c}</option>`).join('');
          // Ensure selectedCurrency is valid
          if (currencies.includes(selectedCurrency)) {
            currencySelect.value = selectedCurrency;
          } else {
            selectedCurrency = currencies[0] || '';
            currencySelect.value = selectedCurrency;
          }
        } else {
          // Handle case where rates are not available
          rates = {};
          currencySelect.innerHTML = '';
        }
        render();
      });

      currencySelect.addEventListener('change', (e) => {
        selectedCurrency = e.target.value;
        render();
      });

      function renderHoldings() {
        const holdingsTable = document.querySelector('#holdings-table tbody');
        db.collection('transactions').onSnapshot(snapshot => {
          const holdings = {};
          snapshot.forEach(doc => {
            const transaction = doc.data();
            const stockId = transaction.stock_id;
            if (!holdings[stockId]) {
              holdings[stockId] = {
                shares: 0,
                cost: 0
              };
            }
            if (transaction.type === 'buy') {
              holdings[stockId].shares += transaction.shares_adjusted;
              holdings[stockId].cost += transaction.price_original * transaction.shares_original;
            } else if (transaction.type === 'sell') {
              holdings[stockId].shares -= transaction.shares_adjusted;
              holdings[stockId].cost -= transaction.price_original * transaction.shares_original;
            }
          });

          holdingsTable.innerHTML = '';
          for (const stockId in holdings) {
            const holding = holdings[stockId];
            db.collection('stocks').doc(stockId).get().then(stockDoc => {
              if (stockDoc.exists) {
                const stock = stockDoc.data();
                if (stock && stock.currency && typeof stock.price !== 'undefined') {
                  const rate = rates[selectedCurrency] / rates[stock.currency];
                  const marketValue = holding.shares * stock.price * rate;
                  const costBasis = holding.cost * rate;
                  const gainLoss = marketValue - costBasis;
                  const row = holdingsTable.insertRow();
                  row.innerHTML = `
                    <td>${stockId}</td>
                    <td>${holding.shares.toFixed(2)}</td>
                    <td>${formatCurrency(stock.price * rate)}</td>
                    <td>${formatCurrency(marketValue)}</td>
                    <td>${formatCurrency(costBasis)}</td>
                    <td>${formatCurrency(gainLoss)}</td>
                  `;
                } else {
                  console.error(`Stock data for ${stockId} is incomplete.`, stock);
                }
              } else {
                console.error(`Document for stock ${stockId} not found in 'stocks' collection.`);
              }
            });
          }
        });
      }

      function renderTransactions() {
        const transactionsTable = document.querySelector('#transactions-table tbody');
        db.collection('transactions').orderBy('date', 'desc').onSnapshot(snapshot => {
          transactionsTable.innerHTML = '';
          snapshot.forEach(doc => {
            const transaction = doc.data();
            const rate = rates[selectedCurrency] / rates[transaction.currency_original];
            const total = transaction.shares_original * transaction.price_original * rate;
            const row = transactionsTable.insertRow();
            row.innerHTML = `
              <td>${transaction.date}</td>
              <td>${transaction.stock_id}</td>
              <td>${transaction.type}</td>
              <td>${transaction.shares_original}</td>
              <td>${formatCurrency(transaction.price_original * rate)}</td>
              <td>${formatCurrency(total)}</td>
            `;
          });
        });
      }
    </script>
  </body>
</html>
