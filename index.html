<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>股票交易紀錄與資產分析系統 (TWR 最終版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script src="https://cdn.jsdelivr.net/npm/lucide@0.378.0/dist/umd/lucide.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; background-color: #f0f2f5; }
        .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); transition: all 0.3s ease-in-out; }
        .card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); }
        .btn { transition: all 0.2s ease-in-out; }
        .btn:hover { transform: scale(1.05); }
        .modal-backdrop { background-color: rgba(0,0,0,0.5); transition: opacity 0.3s ease; }
    </style>
</head>
<body class="text-gray-800">

    <div id="app" class="min-h-screen">
        </div>

    <script type="module">
    // =========================================================================================
    // == 前端 JavaScript 完整程式碼 (v1.5.1 - 真正完整、無省略最終版)
    // =========================================================================================

    const API = {
      URL: 'https://portfolio-journal-api-951186116587.asia-east1.run.app', // <-- 請再次確認這是您自己的 Cloud Run 服務網址
      KEY: 'QqcUhBV04KciA1xeDibpOmcLpAQWDt' // <-- 請再次確認這是您自己的 API KEY
    };

    const currentUserId = "test-user-01";
    let transactions = [];
    let userSplits = [];
    let chart, twrChart;
    let confirmCallback = null;

    // --- 主流程 ---
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('auth-container').style.display = 'none';
        document.getElementById('logout-btn').style.display = 'none';
        document.getElementById('user-info').classList.remove('hidden');
        document.getElementById('user-id').textContent = `測試使用者: ${currentUserId}`;
        document.getElementById('auth-status').textContent = '已連線';
        document.querySelector('main').classList.remove('hidden');

        initializeChart();
        initializeTwrChart();
        setupEventListeners();
        lucide.createIcons();
        
        loadPortfolioData();
    });

    async function loadPortfolioData() {
        document.getElementById('loading-overlay').style.display = 'flex';
        try {
            const response = await fetch(API.URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-API-KEY': API.KEY },
                body: JSON.stringify({ action: 'get_data', uid: currentUserId })
            });
            const result = await response.json();
            if (!response.ok) throw new Error(result.message || '伺服器發生錯誤');
            
            const portfolioData = result.data;
            transactions = portfolioData.transactions || [];
            userSplits = portfolioData.splits || [];
            const holdingsObject = (portfolioData.holdings || []).reduce((obj, item) => {
                obj[item.symbol] = item; return obj;
            }, {});
            
            renderHoldingsTable(holdingsObject);
            renderTransactionsTable();
            renderSplitsTable();
            updateDashboard(holdingsObject, portfolioData.summary?.totalRealizedPL, portfolioData.summary?.overallReturnRate, portfolioData.summary?.xirr);
            updateAssetChart(portfolioData.history || {});
            const benchmarkSymbol = portfolioData.summary?.benchmarkSymbol || 'SPY';
            updateTwrChart(portfolioData.twrHistory || {}, portfolioData.benchmarkHistory || {}, benchmarkSymbol);
            document.getElementById('benchmark-symbol-input').value = benchmarkSymbol;
            showNotification('success', '資料同步完成！');
        } catch (error) {
            console.error('Failed to load portfolio data:', error);
            showNotification('error', `讀取資料失敗: ${error.message}`);
        } finally {
            document.getElementById('loading-overlay').style.display = 'none';
        }
    }

    // --- UI 渲染函式 ---
    function renderHoldingsTable(currentHoldings) {
        const tableBody = document.getElementById('holdings-table-body');
        tableBody.innerHTML = '';
        const holdingsArray = Object.values(currentHoldings);
        if (holdingsArray.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="8" class="text-center py-10 text-gray-500">沒有持股紀錄，請新增一筆交易。</td></tr>`;
            return;
        }
        holdingsArray.sort((a,b) => b.marketValueTWD - a.marketValueTWD).forEach(h => {
            const row = document.createElement('tr');
            row.className = "hover:bg-gray-50";
            const decimals = isTwStock(h.symbol) ? 0 : 2;
            row.innerHTML = `<td class="px-6 py-4 whitespace-nowrap font-medium text-gray-900">${h.symbol}</td><td class="px-6 py-4 whitespace-nowrap">${formatNumber(h.quantity, decimals)}</td><td class="px-6 py-4 whitespace-nowrap">${formatNumber(h.avgCostOriginal, 2)} <span class="text-xs text-gray-500">${h.currency}</span></td><td class="px-6 py-4 whitespace-nowrap">${formatNumber(h.totalCostTWD, 0)}</td><td class="px-6 py-4 whitespace-nowrap">${formatNumber(h.currentPriceOriginal, 2)} <span class="text-xs text-gray-500">${h.currency}</span></td><td class="px-6 py-4 whitespace-nowrap">${formatNumber(h.marketValueTWD, 0)}</td><td class="px-6 py-4 whitespace-nowrap font-semibold ${h.unrealizedPLTWD >= 0 ? 'text-red-600' : 'text-green-600'}">${formatNumber(h.unrealizedPLTWD, 0)}</td><td class="px-6 py-4 whitespace-nowrap font-semibold ${h.returnRate >= 0 ? 'text-red-600' : 'text-green-600'}">${(h.returnRate || 0).toFixed(2)}%</td>`;
            tableBody.appendChild(row);
        });
    }
    
    function renderTransactionsTable() {
        const tableBody = document.getElementById('transactions-table-body');
        tableBody.innerHTML = '';
        if (transactions.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="7" class="text-center py-10 text-gray-500">沒有交易紀錄。</td></tr>`;
            return;
        }
        for (const t of transactions) {
            const row = document.createElement('tr');
            row.className = "hover:bg-gray-50";
            const totalAmountTWD = (t.totalCost || (t.quantity * t.price)) * (t.exchangeRate || 1);
            row.innerHTML = `<td class="px-6 py-4 whitespace-nowrap">${t.date.split('T')[0]}</td><td class="px-6 py-4 whitespace-nowrap font-medium">${t.symbol.toUpperCase()}</td><td class="px-6 py-4 whitespace-nowrap font-semibold ${t.type === 'buy' ? 'text-red-500' : 'text-green-500'}">${t.type === 'buy' ? '買入' : '賣出'}</td><td class="px-6 py-4 whitespace-nowrap">${formatNumber(t.quantity, isTwStock(t.symbol) ? 0 : 2)}</td><td class="px-6 py-4 whitespace-nowrap">${formatNumber(t.price)} <span class="text-xs text-gray-500">${t.currency}</span></td><td class="px-6 py-4 whitespace-nowrap">${formatNumber(totalAmountTWD, 0)}</td><td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium"><button data-id="${t.id}" class="edit-btn text-indigo-600 hover:text-indigo-900 mr-3">編輯</button><button data-id="${t.id}" class="delete-btn text-red-600 hover:text-red-900">刪除</button></td>`;
            tableBody.appendChild(row);
        };
    }

    function renderSplitsTable() {
        const tableBody = document.getElementById('splits-table-body');
        tableBody.innerHTML = '';
        if (userSplits.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="4" class="text-center py-10 text-gray-500">沒有自定義拆股事件。</td></tr>`;
            return;
        }
        for (const s of userSplits) {
            const row = document.createElement('tr');
            row.className = "hover:bg-gray-50";
            row.innerHTML = `<td class="px-6 py-4 whitespace-nowrap">${s.date.split('T')[0]}</td><td class="px-6 py-4 whitespace-nowrap font-medium">${s.symbol.toUpperCase()}</td><td class="px-6 py-4 whitespace-nowrap">${s.ratio}</td><td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium"><button data-id="${s.id}" class="delete-split-btn text-red-600 hover:text-red-900">刪除</button></td>`;
            tableBody.appendChild(row);
        }
    }

    function updateDashboard(currentHoldings, realizedPL, overallReturn, xirr) {
        const holdingsArray = Object.values(currentHoldings);
        const totalMarketValue = holdingsArray.reduce((sum, h) => sum + (h.marketValueTWD || 0), 0);
        const totalUnrealizedPL = holdingsArray.reduce((sum, h) => sum + (h.unrealizedPLTWD || 0), 0);
        document.getElementById('total-assets').textContent = formatNumber(totalMarketValue, 0);
        const unrealizedEl = document.getElementById('unrealized-pl');
        unrealizedEl.textContent = formatNumber(totalUnrealizedPL, 0);
        unrealizedEl.className = `text-3xl font-bold mt-2 ${totalUnrealizedPL >= 0 ? 'text-red-600' : 'text-green-600'}`;
        const realizedEl = document.getElementById('realized-pl');
        realizedEl.textContent = formatNumber(realizedPL, 0);
        realizedEl.className = `text-3xl font-bold mt-2 ${realizedPL >= 0 ? 'text-red-600' : 'text-green-600'}`;
        const totalReturnEl = document.getElementById('total-return');
        totalReturnEl.textContent = `${(overallReturn || 0).toFixed(2)}%`;
        totalReturnEl.className = `text-3xl font-bold mt-2 ${overallReturn >= 0 ? 'text-red-600' : 'text-green-600'}`;
        const xirrEl = document.getElementById('xirr-value');
        xirrEl.textContent = `${((xirr || 0) * 100).toFixed(2)}%`;
        xirrEl.className = `text-3xl font-bold mt-2 ${xirr >= 0 ? 'text-red-600' : 'text-green-600'}`;
    }

    function updateAssetChart(portfolioHistory) {
        if (!portfolioHistory || Object.keys(portfolioHistory).length === 0) { chart.updateSeries([{ data: [] }]); return; }
        const chartData = Object.entries(portfolioHistory).sort((a, b) => new Date(a[0]) - new Date(b[0])).map(([date, value]) => [new Date(date).getTime(), value]);
        chart.updateSeries([{ data: chartData }]);
    }
    
    function updateTwrChart(twrHistory, benchmarkHistory, benchmarkSymbol) {
        const formatHistory = (history) => history ? Object.entries(history).sort((a, b) => new Date(a[0]) - new Date(b[0])).map(([date, value]) => [new Date(date).getTime(), value]) : [];
        twrChart.updateSeries([ { name: '投資組合', data: formatHistory(twrHistory) }, { name: `Benchmark (${benchmarkSymbol || '...'})`, data: formatHistory(benchmarkHistory) } ]);
    }

    // --- 事件處理函式 ---
    async function apiRequest(action, data) {
        const payload = { action, uid: currentUserId, data };
        const response = await fetch(API.URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-API-KEY': API.KEY },
            body: JSON.stringify(payload)
        });
        const result = await response.json();
        if (!response.ok) throw new Error(result.message || '伺服器發生錯誤');
        return result;
    }

    function handleEdit(e) {
        const txId = e.target.dataset.id;
        const transaction = transactions.find(t => t.id === txId);
        if (!transaction) return;
        openModal('transaction-modal', true, transaction);
    }

    async function handleDelete(e) {
        const txId = e.target.dataset.id;
        showConfirm('確定要刪除這筆交易紀錄嗎？', async () => {
            try {
                await apiRequest('delete_transaction', { txId });
                showNotification('success', '交易紀錄已刪除！');
                await loadPortfolioData();
            } catch (error) {
                showNotification('error', `刪除失敗: ${error.message}`);
            }
        });
    }

    async function handleDeleteSplit(e) {
        const splitId = e.target.dataset.id;
        showConfirm('確定要刪除這個拆股事件嗎？', async () => {
            try {
                await apiRequest('delete_split', { splitId });
                showNotification('success', '拆股事件已刪除！');
                await loadPortfolioData();
            } catch (error) {
                showNotification('error', `刪除失敗: ${error.message}`);
            }
        });
    }
    
    async function handleFormSubmit(e) {
        e.preventDefault();
        const saveBtn = document.getElementById('save-btn');
        saveBtn.disabled = true;
        saveBtn.innerHTML = `<svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> 儲存中...`;
    
        const txId = document.getElementById('transaction-id').value;
        const isEditing = !!txId;
    
        const transactionData = {
            date: document.getElementById('transaction-date').value,
            symbol: document.getElementById('stock-symbol').value.toUpperCase().trim(),
            type: document.querySelector('input[name="transaction-type"]:checked').value,
            quantity: parseFloat(document.getElementById('quantity').value),
            price: parseFloat(document.getElementById('price').value),
            currency: document.getElementById('currency').value,
            totalCost: parseFloat(document.getElementById('total-cost').value) || null,
            exchangeRate: parseFloat(document.getElementById('exchange-rate').value) || null
        };
    
        if (!transactionData.symbol || isNaN(transactionData.quantity) || isNaN(transactionData.price)) {
            showNotification('error', '請填寫所有必填欄位。');
            saveBtn.disabled = false;
            saveBtn.textContent = '儲存';
            return;
        }
    
        try {
            const action = isEditing ? 'edit_transaction' : 'add_transaction';
            const payload = isEditing ? { txId, txData: transactionData } : transactionData;
    
            await apiRequest(action, payload);
    
            closeModal('transaction-modal');
            await loadPortfolioData();
            showNotification('success', isEditing ? '交易已更新！' : '交易已新增！');
    
        } catch (error) {
            console.error('Failed to save transaction:', error);
            showNotification('error', `儲存交易失敗: ${error.message}`);
        } finally {
            saveBtn.disabled = false;
            saveBtn.textContent = '儲存';
        }
    }

    async function handleSplitFormSubmit(e) {
        e.preventDefault();
        const saveBtn = document.getElementById('save-split-btn');
        saveBtn.disabled = true;
        const splitData = { date: document.getElementById('split-date').value, symbol: document.getElementById('split-symbol').value.toUpperCase().trim(), ratio: parseFloat(document.getElementById('split-ratio').value) };
        if (!splitData.symbol || isNaN(splitData.ratio) || splitData.ratio <= 0) {
            showNotification('error', '請填寫所有欄位並確保比例大於0。');
            saveBtn.disabled = false; return;
        }
        try {
            await apiRequest('add_split', { splitData });
            closeModal('split-modal');
            await loadPortfolioData();
        } catch (error) {
            console.error('Failed to add split event:', error);
            showNotification('error', `新增拆股事件失敗: ${error.message}`);
        } finally {
            saveBtn.disabled = false;
        }
    }
    
    async function handleUpdateBenchmark() {
        const newBenchmark = document.getElementById('benchmark-symbol-input').value.toUpperCase().trim();
        if (!newBenchmark) { showNotification('error', '請輸入 Benchmark 的股票代碼。'); return; }
        try {
            showNotification('info', `正在更新 Benchmark 並重算...`);
            await apiRequest('update_benchmark', { benchmarkSymbol: newBenchmark });
            await loadPortfolioData();
        } catch(error) {
            showNotification('error', `更新 Benchmark 失敗: ${error.message}`);
        }
    }

    // --- 輔助與初始化函式 ---
    function setupEventListeners() {
        document.getElementById('add-transaction-btn').addEventListener('click', () => openModal('transaction-modal', false, null));
        document.getElementById('transaction-form').addEventListener('submit', handleFormSubmit);
        document.getElementById('cancel-btn').addEventListener('click', () => closeModal('transaction-modal'));
        document.getElementById('tabs').addEventListener('click', (e) => { e.preventDefault(); if (e.target.matches('.tab-item')) { switchTab(e.target.dataset.tab); } });
        document.getElementById('transactions-table-body').addEventListener('click', (e) => { if (e.target.classList.contains('edit-btn')) { handleEdit(e); } if (e.target.classList.contains('delete-btn')) { handleDelete(e); } });
        document.getElementById('splits-table-body').addEventListener('click', (e) => { if (e.target.classList.contains('delete-split-btn')) { handleDeleteSplit(e); } });
        document.getElementById('manage-splits-btn').addEventListener('click', () => openModal('split-modal'));
        document.getElementById('split-form').addEventListener('submit', handleSplitFormSubmit);
        document.getElementById('cancel-split-btn').addEventListener('click', () => closeModal('split-modal'));
        document.getElementById('confirm-cancel-btn').addEventListener('click', hideConfirm);
        document.getElementById('confirm-ok-btn').addEventListener('click', () => { if (confirmCallback) { confirmCallback(); } hideConfirm(); });
        document.getElementById('currency').addEventListener('change', toggleOptionalFields);
        document.getElementById('update-benchmark-btn').addEventListener('click', handleUpdateBenchmark);
    }

    function initializeChart() {
        const options = { chart: { type: 'area', height: 350, zoom: { enabled: true }, toolbar: { show: true } }, series: [{ name: '總資產', data: [] }], xaxis: { type: 'datetime', labels: { datetimeUTC: false, format: 'yy/MM/dd' } }, yaxis: { labels: { formatter: (value) => { return formatNumber(value, 0) } } }, dataLabels: { enabled: false }, stroke: { curve: 'smooth', width: 2 }, fill: { type: 'gradient', gradient: { shadeIntensity: 1, opacityFrom: 0.7, opacityTo: 0.3, stops: [0, 90, 100] } }, tooltip: { x: { format: 'yyyy/MM/dd' }, y: { formatter: (value) => { return formatNumber(value,0) } } }, colors: ['#4f46e5'] };
        chart = new ApexCharts(document.querySelector("#asset-chart"), options);
        chart.render();
    }

    function initializeTwrChart() {
        const options = { chart: { type: 'line', height: 350, zoom: { enabled: true }, toolbar: { show: true } }, series: [{ name: '投資組合', data: [] }, { name: 'Benchmark', data: [] }], xaxis: { type: 'datetime', labels: { datetimeUTC: false, format: 'yy/MM/dd' } }, yaxis: { labels: { formatter: (value) => `${(value || 0).toFixed(2)}%` } }, dataLabels: { enabled: false }, stroke: { curve: 'smooth', width: 2 }, tooltip: { y: { formatter: (value) => `${(value || 0).toFixed(2)}%` } }, colors: ['#4f46e5', '#f59e0b'] };
        twrChart = new ApexCharts(document.querySelector("#twr-chart"), options);
        twrChart.render();
    }

    function openModal(modalId, isEdit = false, data = null) { 
        const formId = modalId.replace('-modal', '-form');
        const form = document.getElementById(formId);
        if (form) form.reset();
        
        if (modalId === 'transaction-modal') {
            document.getElementById('transaction-id').value = '';
            if(isEdit && data) {
                document.getElementById('modal-title').textContent = '編輯交易紀錄'; 
                document.getElementById('transaction-id').value = data.id; 
                document.getElementById('transaction-date').value = data.date.split('T')[0];
                document.getElementById('stock-symbol').value = data.symbol; 
                document.querySelector(`input[name="transaction-type"][value="${data.type}"]`).checked = true; 
                document.getElementById('quantity').value = data.quantity; 
                document.getElementById('price').value = data.price; 
                document.getElementById('currency').value = data.currency;
                document.getElementById('exchange-rate').value = data.exchangeRate || '';
                document.getElementById('total-cost').value = data.totalCost || '';
            } else {
                document.getElementById('modal-title').textContent = '新增交易紀錄'; 
                document.getElementById('transaction-date').value = new Date().toISOString().split('T')[0];
            }
        } else if (modalId === 'split-modal') {
             document.getElementById('split-date').value = new Date().toISOString().split('T')[0];
        }
        document.getElementById(modalId).classList.remove('hidden');
    }

    function closeModal(modalId) { 
        document.getElementById(modalId).classList.add('hidden');
    }

    function showConfirm(message, callback) { 
        document.getElementById('confirm-message').textContent = message; 
        confirmCallback = callback; 
        document.getElementById('confirm-modal').classList.remove('hidden'); 
    }

    function hideConfirm() { 
        confirmCallback = null; 
        document.getElementById('confirm-modal').classList.add('hidden'); 
    }

    function toggleOptionalFields() {
        const currency = document.getElementById('currency').value;
        const exchangeRateField = document.getElementById('exchange-rate-field');
        if (currency === 'TWD') {
            exchangeRateField.style.display = 'none';
        } else {
            exchangeRateField.style.display = 'block';
        }
    }
    
    function isTwStock(symbol) { 
        return symbol ? symbol.toUpperCase().endsWith('.TW') || symbol.toUpperCase().endsWith('.TWO') : false; 
    }
    
    function formatNumber(value, decimals = 2) { 
        const num = Number(value); 
        if (isNaN(num)) return decimals === 0 ? '0' : '0.00'; 
        return num.toLocaleString('en-US', { minimumFractionDigits: decimals, maximumFractionDigits: decimals }); 
    }

    function showNotification(type, message) { 
        const area = document.getElementById('notification-area'); 
        const color = type === 'success' ? 'bg-green-500' : (type === 'info' ? 'bg-blue-500' : 'bg-red-500'); 
        const icon = type === 'success' ? 'check-circle' : (type === 'info' ? 'info' : 'alert-circle'); 
        const notification = document.createElement('div'); 
        notification.className = `flex items-center ${color} text-white text-sm font-bold px-4 py-3 rounded-md shadow-lg mb-2`; 
        notification.innerHTML = `<i data-lucide="${icon}" class="w-5 h-5 mr-2"></i><p>${message}</p>`; 
        area.appendChild(notification); 
        lucide.createIcons({nodes: [notification.querySelector('i')]});
        setTimeout(() => { 
            notification.style.transition = 'opacity 0.5s ease'; 
            notification.style.opacity = '0'; 
            setTimeout(() => notification.remove(), 500); 
        }, 5000); 
    }
    
    function switchTab(tabName) { 
        document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden')); 
        document.getElementById(`${tabName}-tab`).classList.remove('hidden'); 
        document.querySelectorAll('.tab-item').forEach(el => { 
            el.classList.remove('border-indigo-500', 'text-indigo-600'); 
            el.classList.add('border-transparent', 'text-gray-500'); 
        }); 
        const activeTab = document.querySelector(`[data-tab="${tabName}"]`); 
        activeTab.classList.add('border-indigo-500', 'text-indigo-600'); 
        activeTab.classList.remove('border-transparent', 'text-gray-500'); 
    }
    </script>
</body>
</html>
