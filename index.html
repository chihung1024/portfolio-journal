<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>股票交易紀錄與資產分析系統 (最終修正版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script src="https://cdn.jsdelivr.net/npm/lucide@0.378.0/dist/umd/lucide.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; background-color: #f0f2f5; }
        .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); transition: all 0.3s ease-in-out; }
        .card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); }
        .btn { transition: all 0.2s ease-in-out; }
        .btn:hover { transform: scale(1.05); }
        .modal-backdrop { background-color: rgba(0,0,0,0.5); transition: opacity 0.3s ease; }
        .optional-field { display: none; }
    </style>
</head>
<body class="text-gray-800">

    <div id="app" class="min-h-screen">
        <div id="notification-area" class="fixed top-5 right-5 z-50"></div>

        <header class="bg-white shadow-md sticky top-0 z-20">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <i data-lucide="line-chart" class="text-indigo-600 h-8 w-8"></i>
                    <h1 class="text-2xl font-bold text-gray-800">交易紀錄與資產分析 (最終修正版)</h1>
                </div>
                <div id="auth-status-display" class="flex items-center space-x-4 text-xs text-gray-500 text-right">
                    <div id="user-info" class="hidden">
                        <span id="auth-status">已連線</span>
                        <p id="user-id" class="truncate max-w-[150px] sm:max-w-xs"></p>
                    </div>
                    <button id="logout-btn" class="hidden btn bg-red-500 text-white font-bold py-1 px-3 rounded-lg shadow-md hover:bg-red-600">登出</button>
                </div>
            </div>
        </header>
        
        <div id="auth-container" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 hidden">
            <div class="max-w-md mx-auto bg-white rounded-lg shadow-md p-8">
                <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">登入或註冊</h2>
                <form id="auth-form">
                    <div class="mb-4">
                        <label for="email" class="block text-sm font-medium text-gray-700 mb-1">電子郵件</label>
                        <input type="email" id="email" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required>
                    </div>
                    <div class="mb-6">
                        <label for="password" class="block text-sm font-medium text-gray-700 mb-1">密碼</label>
                        <input type="password" id="password" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required>
                    </div>
                    <div class="flex items-center justify-between space-x-4">
                        <button type="button" id="login-btn" class="w-full btn bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700">登入</button>
                        <button type="button" id="register-btn" class="w-full btn bg-gray-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-gray-700">註冊</button>
                    </div>
                </form>
            </div>
        </div>
        
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 hidden">
            <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-40">
                <div class="flex flex-col items-center text-center p-4">
                    <svg id="loading-spinner-icon" class="animate-spin h-10 w-10 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    <p id="loading-text" class="mt-4 text-lg font-medium text-gray-700">正在從雲端同步資料...</p>
                </div>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
                <div class="card p-5 flex flex-col justify-between"><div class="flex items-center justify-between"><h3 class="text-sm font-medium text-gray-500">總資產 (TWD)</h3><i data-lucide="wallet" class="h-6 w-6 text-gray-400"></i></div><p id="total-assets" class="text-3xl font-bold text-gray-800 mt-2">0</p></div>
                <div class="card p-5 flex flex-col justify-between"><div class="flex items-center justify-between"><h3 class="text-sm font-medium text-gray-500">未實現損益 (TWD)</h3><i data-lucide="trending-up" class="h-6 w-6 text-gray-400"></i></div><p id="unrealized-pl" class="text-3xl font-bold text-gray-800 mt-2">0</p></div>
                <div class="card p-5 flex flex-col justify-between"><div class="flex items-center justify-between"><h3 class="text-sm font-medium text-gray-500">已實現損益 (TWD)</h3><i data-lucide="dollar-sign" class="h-6 w-6 text-gray-400"></i></div><p id="realized-pl" class="text-3xl font-bold text-gray-800 mt-2">0</p></div>
                <div class="card p-5 flex flex-col justify-between"><div class="flex items-center justify-between"><h3 class="text-sm font-medium text-gray-500">總報酬率</h3><i data-lucide="percent" class="h-6 w-6 text-gray-400"></i></div><p id="total-return" class="text-3xl font-bold text-gray-800 mt-2">0.00%</p></div>
                <div class="card p-5 flex flex-col justify-between"><div class="flex items-center justify-between"><h3 class="text-sm font-medium text-gray-500">XIRR 年化報酬率</h3><i data-lucide="calendar-check" class="h-6 w-6 text-gray-400"></i></div><p id="xirr-value" class="text-3xl font-bold text-gray-800 mt-2">0.00%</p></div>
            </div>

            <div class="card p-6 mb-8">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4">
                    <div class="sm:flex sm:items-center sm:space-x-4"><h2 class="text-xl font-bold text-gray-800">投資組合</h2><div class="mt-2 sm:mt-0 border-b sm:border-b-0 sm:border-l border-gray-200 sm:pl-4"><nav class="-mb-px flex space-x-6" id="tabs"><a href="#" data-tab="holdings" class="tab-item whitespace-nowrap border-b-2 font-medium text-sm border-indigo-500 text-indigo-600">持股一覽</a><a href="#" data-tab="transactions" class="tab-item whitespace-nowrap border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">交易紀錄</a><a href="#" data-tab="splits" class="tab-item whitespace-nowrap border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">拆股事件</a></nav></div></div>
                    <div class="flex space-x-2">
                        <button id="manage-splits-btn" class="btn bg-gray-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-gray-700 flex items-center space-x-2"><i data-lucide="git-merge" class="h-5 w-5"></i><span>管理拆股</span></button>
                        <button id="add-transaction-btn" class="btn bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 flex items-center space-x-2"><i data-lucide="plus-circle" class="h-5 w-5"></i><span>新增交易</span></button>
                    </div>
                </div>
                <div id="holdings-tab" class="tab-content overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">代碼</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">股數</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">平均成本(原幣)</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">總成本(TWD)</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">現價(原幣)</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">市值(TWD)</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">未實現損益(TWD)</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">報酬率</th></tr></thead><tbody id="holdings-table-body" class="bg-white divide-y divide-gray-200"></tbody></table></div>
                <div id="transactions-tab" class="tab-content overflow-x-auto hidden"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">日期</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">代碼</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">類型</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">股數</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">價格(原幣)</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">總金額(TWD)</th><th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th></tr></thead><tbody id="transactions-table-body" class="bg-white divide-y divide-gray-200"></tbody></table></div>
                <div id="splits-tab" class="tab-content overflow-x-auto hidden"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">日期</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">代碼</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">比例</th><th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th></tr></thead><tbody id="splits-table-body" class="bg-white divide-y divide-gray-200"></tbody></table></div>
            </div>

            <div class="card p-6">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-3">
                    <h3 class="text-lg font-semibold text-gray-800">時間加權報酬走勢圖 (%)</h3>
                    <div class="flex items-center gap-2">
                        <label for="benchmark-symbol-input" class="text-sm text-gray-600">比較基準:</label>
                        <input type="text" id="benchmark-symbol-input" value="SPY" class="w-24 px-2 py-1 border border-gray-300 rounded-md shadow-sm text-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        <button id="save-benchmark-btn" class="btn bg-indigo-600 text-white text-sm font-bold py-1 px-3 rounded-lg shadow-md hover:bg-indigo-700">設定</button>
                    </div>
                </div>
                <div id="twr-chart"></div>
            </div>
            
            <div class="card p-6 mt-8"><h3 class="text-lg font-semibold text-gray-800 mb-4">資產成長曲線 (TWD)</h3><div id="asset-chart"></div></div>

        </main>

        <div id="transaction-modal" class="fixed inset-0 z-30 overflow-y-auto hidden"><div class="flex items-center justify-center min-h-screen"><div class="fixed inset-0 modal-backdrop" id="modal-backdrop-trans"></div><div class="bg-white rounded-lg shadow-xl p-8 z-40 w-full max-w-md mx-4"><h3 id="modal-title" class="text-2xl font-bold mb-6 text-gray-800">新增交易紀錄</h3><form id="transaction-form"><input type="hidden" id="transaction-id"><div class="mb-4"><label for="transaction-date" class="block text-sm font-medium text-gray-700 mb-1">日期</label><input type="date" id="transaction-date" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required></div><div class="mb-4"><label for="stock-symbol" class="block text-sm font-medium text-gray-700 mb-1">股票代碼</label><input type="text" id="stock-symbol" placeholder="例如: AAPL, 2330.TW" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required></div><div class="mb-4"><label class="block text-sm font-medium text-gray-700 mb-1">交易類型</label><div class="flex space-x-4"><label class="flex items-center"><input type="radio" name="transaction-type" value="buy" class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500" checked><span class="ml-2 text-gray-700">買入</span></label><label class="flex items-center"><input type="radio" name="transaction-type" value="sell" class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500"><span class="ml-2 text-gray-700">賣出</span></label></div></div><div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4"><div><label for="quantity" class="block text-sm font-medium text-gray-700 mb-1">股數</label><input type="number" step="any" id="quantity" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required></div><div><label for="price" class="block text-sm font-medium text-gray-700 mb-1">價格 (原幣)</label><input type="number" step="any" id="price" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required></div></div><div class="mb-4"><label for="currency" class="block text-sm font-medium text-gray-700 mb-1">幣別</label><select id="currency" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"><option value="USD">USD</option><option value="TWD">TWD</option></select></div>
                <div id="exchange-rate-field" class="space-y-4 mb-4 p-4 border border-gray-200 rounded-md optional-field">
                    <label for="exchange-rate" class="block text-sm font-medium text-gray-700 mb-1">手動匯率 (選填)</label>
                    <input type="number" step="any" id="exchange-rate" placeholder="留空則自動抓取" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div id="total-cost-field" class="space-y-4 mb-4 p-4 border border-gray-200 rounded-md">
                    <label for="total-cost" class="block text-sm font-medium text-gray-700 mb-1">總成本 (含費用, 原幣, 選填)</label>
                    <input type="number" step="any" id="total-cost" placeholder="留空則自動計算 (股數*價格)" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div class="flex justify-end space-x-4 mt-6"><button type="button" id="cancel-btn" class="btn bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">取消</button><button type="submit" id="save-btn" class="btn bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700">儲存</button></div></form></div></div></div>
        <div id="split-modal" class="fixed inset-0 z-30 overflow-y-auto hidden"><div class="flex items-center justify-center min-h-screen"><div class="fixed inset-0 modal-backdrop" id="modal-backdrop-split"></div><div class="bg-white rounded-lg shadow-xl p-8 z-40 w-full max-w-md mx-4"><h3 class="text-2xl font-bold mb-6 text-gray-800">新增拆股/合股事件</h3><form id="split-form"><input type="hidden" id="split-id"><div class="mb-4"><label for="split-date" class="block text-sm font-medium text-gray-700 mb-1">日期</label><input type="date" id="split-date" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required></div><div class="mb-4"><label for="split-symbol" class="block text-sm font-medium text-gray-700 mb-1">股票代碼</label><input type="text" id="split-symbol" placeholder="例如: AAPL, 2330.TW" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required></div><div class="mb-4"><label for="split-ratio" class="block text-sm font-medium text-gray-700 mb-1">比例</label><input type="number" step="any" id="split-ratio" placeholder="1拆10, 輸入10; 10合1, 輸入0.1" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required></div><div class="flex justify-end space-x-4 mt-6"><button type="button" id="cancel-split-btn" class="btn bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">取消</button><button type="submit" id="save-split-btn" class="btn bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700">儲存</button></div></form></div></div></div>
        <div id="confirm-modal" class="fixed inset-0 z-50 overflow-y-auto hidden"><div class="flex items-center justify-center min-h-screen"><div class="fixed inset-0 modal-backdrop"></div><div class="bg-white rounded-lg shadow-xl p-8 z-50 w-full max-w-sm mx-4"><h3 id="confirm-title" class="text-lg font-semibold mb-4 text-gray-800">確認操作</h3><p id="confirm-message" class="text-gray-600 mb-6">您確定要執行此操作嗎？</p><div class="flex justify-end space-x-4"><button id="confirm-cancel-btn" class="btn bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">取消</button><button id="confirm-ok-btn" class="btn bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-red-700">確定</button></div></div></div></div>
    </div>

<script type="module">
    // --- Firebase SDK ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, collection, doc, addDoc, onSnapshot, updateDoc, deleteDoc, query, orderBy, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // --- Firebase 設定 ---
    const firebaseConfig = {
        apiKey: "AIzaSyAlymQXtutAG8UY48-TehVU70jD9RmCiBE",
        authDomain: "trading-journal-4922c.firebaseapp.com",
        projectId: "trading-journal-4922c",
        storageBucket: "trading-journal-4922c.appspot.com",
        messagingSenderId: "50863752247",
        appId: "1:50863752247:web:766eaa892d2c8d28bb6bb2"
    };

    // --- 全域變數 ---
    let db, auth, userId;
    let chart, twrChart;
    let transactions = [], userSplits = [], holdings = {};
    let realizedPLFromBackend = 0, overallReturnRateFromBackend = 0, xirrFromBackend = 0;
    let unsubscribers = [];
    let dataLoaded = { transactions: false, holdings: false, splits: false };
    
    // --- 主程式入口 ---
    document.addEventListener('DOMContentLoaded', () => {
        const app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);
        setupEventListeners();
        initializeAllCharts();
        lucide.createIcons();
        handleAuthentication();
    });

    // --- 核心函式 ---
    function handleAuthentication() {
        onAuthStateChanged(auth, (user) => {
            const mainContent = document.querySelector('main');
            const authContainer = document.getElementById('auth-container');
            const userInfo = document.getElementById('user-info');
            const logoutBtn = document.getElementById('logout-btn');

            if (user) {
                userId = user.uid;
                document.getElementById('user-id').textContent = `使用者: ${user.email}`;
                authContainer.classList.add('hidden');
                mainContent.classList.remove('hidden');
                userInfo.classList.remove('hidden');
                logoutBtn.classList.remove('hidden');
                setupDataListeners();
            } else {
                userId = null;
                unsubscribers.forEach(unsub => unsub()); // 取消所有監聽
                unsubscribers = [];
                authContainer.classList.remove('hidden');
                mainContent.classList.add('hidden');
                userInfo.classList.add('hidden');
                logoutBtn.classList.add('hidden');
                document.getElementById('loading-overlay').style.display = 'none';
            }
        });
    }

    function setupEventListeners() {
        document.getElementById('add-transaction-btn').addEventListener('click', () => openModal());
        document.getElementById('login-btn').addEventListener('click', () => handleLogin(auth));
        document.getElementById('register-btn').addEventListener('click', () => handleRegister(auth));
        document.getElementById('logout-btn').addEventListener('click', () => handleLogout(auth));
        
        // [新增] 設定 benchmark 的按鈕事件
        document.getElementById('save-benchmark-btn').addEventListener('click', handleSaveBenchmark);
        
        // ... 其他事件監聽 ...
        document.getElementById('cancel-btn').addEventListener('click', closeModal);
        document.getElementById('modal-backdrop-trans').addEventListener('click', closeModal);
        document.getElementById('transaction-form').addEventListener('submit', handleFormSubmit);
        document.getElementById('manage-splits-btn').addEventListener('click', openSplitModal);
        document.getElementById('cancel-split-btn').addEventListener('click', closeSplitModal);
        document.getElementById('modal-backdrop-split').addEventListener('click', closeSplitModal);
        document.getElementById('split-form').addEventListener('submit', handleSplitFormSubmit);
        document.getElementById('tabs').addEventListener('click', (e) => { e.preventDefault(); if (e.target.matches('.tab-item')) { switchTab(e.target.dataset.tab); } });
        document.getElementById('confirm-cancel-btn').addEventListener('click', hideConfirm);
        document.getElementById('confirm-ok-btn').addEventListener('click', () => { if (confirmCallback) { confirmCallback(); } hideConfirm(); });
        document.getElementById('currency').addEventListener('change', toggleOptionalFields);
    }
    
    function setupDataListeners() {
        if (!userId) return;

        unsubscribers.forEach(unsub => unsub());
        unsubscribers = [];
        dataLoaded = { transactions: false, holdings: false, splits: false };
        document.getElementById('loading-overlay').style.display = 'flex';

        const checkAllDataLoaded = () => {
            if (dataLoaded.transactions && dataLoaded.holdings && dataLoaded.splits) {
                renderAll();
            }
        };

        const unsubTransactions = onSnapshot(query(collection(db, 'users', userId, 'transactions'), orderBy("date", "asc")), (snapshot) => {
            transactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            dataLoaded.transactions = true; checkAllDataLoaded();
        });
        unsubscribers.push(unsubTransactions);

        const unsubSplits = onSnapshot(query(collection(db, 'users', userId, 'splits'), orderBy("date", "asc")), (snapshot) => {
            userSplits = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            dataLoaded.splits = true; checkAllDataLoaded();
        });
        unsubscribers.push(unsubSplits);
        
        const unsubHoldings = onSnapshot(doc(db, 'users', userId, 'user_data', 'current_holdings'), (docSnap) => {
            if (docSnap.exists()) {
                const data = docSnap.data();
                holdings = data.holdings || {};
                realizedPLFromBackend = data.totalRealizedPL || 0;
                overallReturnRateFromBackend = data.overallReturnRateTotal ?? 0;
                xirrFromBackend = data.xirr || 0;
            } else {
                holdings = {}; realizedPLFromBackend = 0; overallReturnRateFromBackend = 0; xirrFromBackend = 0;
            }
            dataLoaded.holdings = true; checkAllDataLoaded();
        });
        unsubscribers.push(unsubHoldings);
        
        // [修改] 監聽 portfolio_history，現在它包含 benchmark
        const unsubHistory = onSnapshot(doc(db, 'users', userId, 'user_data', 'portfolio_history'), (docSnap) => {
            if (docSnap.exists()) {
                const docData = docSnap.data();
                updateAllCharts(docData); // 將整個文件傳給圖表更新函式
            } else {
                updateAllCharts({});
            }
        });
        unsubscribers.push(unsubHistory);

        // [新增] 監聽使用者偏好設定 (為了 benchmark)
        const unsubPrefs = onSnapshot(doc(db, 'users', userId, 'user_data', 'preferences'), (docSnap) => {
            if (docSnap.exists() && docSnap.data().benchmarkSymbol) {
                document.getElementById('benchmark-symbol-input').value = docSnap.data().benchmarkSymbol;
            } else {
                document.getElementById('benchmark-symbol-input').value = 'SPY'; // 預設值
            }
        });
        unsubscribers.push(unsubPrefs);
    }
    
    function renderAll() {
        renderHoldingsTable();
        renderTransactionsTable();
        renderSplitsTable();
        updateDashboard();
        document.getElementById('loading-overlay').style.display = 'none';
        showNotification('success', '雲端資料同步完成！');
    }

    /* ================================================================
     * Chart Functions
     * ================================================================ */
    function initializeAllCharts() {
        const commonOptions = { chart: { type: 'area', height: 350, zoom: { enabled: true }, toolbar: { show: true } }, dataLabels: { enabled: false }, stroke: { curve: 'smooth', width: 2 }, xaxis: { type: 'datetime', labels: { datetimeUTC: false, format: 'yy/MM/dd' } }, tooltip: { x: { format: 'yyyy/MM/dd' } }, fill: { type: 'gradient', gradient: { shadeIntensity: 1, opacityFrom: 0.7, opacityTo: 0.3, stops: [0, 90, 100] } } };
        
        const assetOptions = { ...commonOptions, series: [{ name: '總資產', data: [] }], yaxis: { labels: { formatter: (val) => val.toLocaleString('en-US', {maximumFractionDigits:0}) } }, tooltip: { y: { formatter: (val) => val.toLocaleString('en-US', {maximumFractionDigits:0}) } }, colors: ['#4f46e5'] };
        chart = new ApexCharts(document.querySelector("#asset-chart"), assetOptions);
        chart.render();

        // [修改] TWR 圖表現在有兩條線
        const twrOptions = { ...commonOptions, series: [{ name: '時間加權報酬', data: [] }, { name: '比較基準', data: [] }], yaxis: { labels: { formatter: (val) => val.toFixed(2) + '%' } }, tooltip: { y: { formatter: (val) => val.toFixed(2) + '%' } }, colors: ['#059669', '#64748b'] };
        twrChart = new ApexCharts(document.querySelector("#twr-chart"), twrOptions);
        twrChart.render();
    }

    // [修改] 更新圖表的函式，現在接收整個 history 文件
    function updateAllCharts(historyDocData) {
        const portfolioHistory = historyDocData?.history || {};
        const benchmark = historyDocData?.benchmark || {};
        const benchmarkSymbol = benchmark.symbol || '比較基準';
        const benchmarkHistory = benchmark.data || {};
        
        // 更新資產圖表
        if (chart) {
            const assetData = Object.entries(portfolioHistory).map(([date, value]) => [new Date(date).getTime(), value.marketValue]);
            chart.updateSeries([{ name: '總資產', data: assetData }]);
        }

        // 更新 TWR 圖表
        if (twrChart) {
            const twrData = Object.entries(portfolioHistory).map(([date, value]) => [new Date(date).getTime(), ((value.twr || 1) - 1) * 100]);
            const benchmarkData = Object.entries(benchmarkHistory).map(([date, value]) => [new Date(date).getTime(), ((value || 1) - 1) * 100]);
            twrChart.updateSeries([
                { name: '時間加權報酬', data: twrData },
                { name: `${benchmarkSymbol} (比較基準)`, data: benchmarkData }
            ]);
        }
    }

    /* ================================================================
     * [新增] Benchmark 處理函式
     * ================================================================ */
    async function handleSaveBenchmark() {
        if (!userId) return;
        const newSymbol = document.getElementById('benchmark-symbol-input').value.toUpperCase().trim();
        if (!newSymbol) {
            showNotification('error', '比較基準代碼不能為空。');
            return;
        }

        const prefRef = doc(db, 'users', userId, 'user_data', 'preferences');
        const holdingsRef = doc(db, 'users', userId, 'user_data', 'current_holdings');

        try {
            await setDoc(prefRef, { benchmarkSymbol: newSymbol }, { merge: true });
            showNotification('success', `比較基準已設定為 ${newSymbol}。`);
            showNotification('info', '正在觸發後端重新計算...');
            // 觸發重新計算
            await setDoc(holdingsRef, { force_recalc_timestamp: new Date() }, { merge: true });
        } catch (error) {
            console.error("儲存 benchmark 失敗:", error);
            showNotification('error', '儲存失敗，請稍後再試。');
        }
    }

    /* ================================================================
     * 其他所有函式 (內容與前一版相同)
     * ================================================================ */
    // ... 將您檔案中所有其他的函式 (handleLogin, handleRegister, renderHoldingsTable, updateDashboard, openModal 等) 完整地複製到此處 ...
    async function handleRegister(auth) { const email = document.getElementById('email').value; const password = document.getElementById('password').value; if (!email || !password) { showNotification('error', '請輸入電子郵件和密碼。'); return; } try { await createUserWithEmailAndPassword(auth, email, password); showNotification('success', '註冊成功！已自動登入。'); } catch (error) { console.error("註冊失敗:", error); showNotification('error', `註冊失敗: ${error.message}`); } }
    async function handleLogin(auth) { const email = document.getElementById('email').value; const password = document.getElementById('password').value; if (!email || !password) { showNotification('error', '請輸入電子郵件和密碼。'); return; } try { await signInWithEmailAndPassword(auth, email, password); showNotification('success', '登入成功！'); } catch (error) { console.error("登入失敗:", error); showNotification('error', `登入失敗: ${error.message}`); } }
    async function handleLogout(auth) { try { await signOut(auth); showNotification('info', '您已成功登出。'); } catch (error) { console.error("登出失敗:", error); showNotification('error', `登出失敗: ${error.message}`); } }
    function renderHoldingsTable() { const tableBody = document.getElementById('holdings-table-body'); tableBody.innerHTML = ''; const holdingsArray = Object.values(holdings); if (holdingsArray.length === 0) { tableBody.innerHTML = `<tr><td colspan="8" class="text-center py-10 text-gray-500">沒有持股紀錄。</td></tr>`; return; } holdingsArray.sort((a,b) => b.marketValueTWD - a.marketValueTWD).forEach(h => { const row = document.createElement('tr'); row.className = "hover:bg-gray-50"; const decimals = isTwStock(h.symbol) ? 0 : 2; row.innerHTML = `<td class="px-6 py-4 whitespace-nowrap font-medium text-gray-900">${h.symbol}</td><td class="px-6 py-4 whitespace-nowrap">${formatNumber(h.quantity, decimals)}</td><td class="px-6 py-4 whitespace-nowrap">${formatNumber(h.avgCostOriginal, 2)} <span class="text-xs text-gray-500">${h.currency}</span></td><td class="px-6 py-4 whitespace-nowrap">${formatNumber(h.totalCostTWD, 0)}</td><td class="px-6 py-4 whitespace-nowrap">${formatNumber(h.currentPriceOriginal, 2)} <span class="text-xs text-gray-500">${h.currency}</span></td><td class="px-6 py-4 whitespace-nowrap">${formatNumber(h.marketValueTWD, 0)}</td><td class="px-6 py-4 whitespace-nowrap font-semibold ${h.unrealizedPLTWD >= 0 ? 'text-red-600' : 'text-green-600'}">${formatNumber(h.unrealizedPLTWD, 0)}</td><td class="px-6 py-4 whitespace-nowrap font-semibold ${h.returnRate >= 0 ? 'text-red-600' : 'text-green-600'}">${(h.returnRate || 0).toFixed(2)}%</td>`; tableBody.appendChild(row); }); }
    async function renderTransactionsTable() { const tableBody = document.getElementById('transactions-table-body'); tableBody.innerHTML = ''; if (transactions.length === 0) { tableBody.innerHTML = `<tr><td colspan="7" class="text-center py-10 text-gray-500">沒有交易紀錄。</td></tr>`; return; } for (const t of [...transactions].reverse()) { const row = document.createElement('tr'); row.className = "hover:bg-gray-50"; const typeText = { buy: '買入', sell: '賣出' }; const typeColor = { buy: 'text-red-500', sell: 'text-green-500' }; const totalAmountOriginal = t.totalCost || (t.quantity * t.price); const transactionDate = t.date.toDate ? t.date.toDate().toISOString().split('T')[0] : t.date; const decimals = isTwStock(t.symbol) ? 0 : 2; row.innerHTML = `<td class="px-6 py-4 whitespace-nowrap">${transactionDate}</td><td class="px-6 py-4 whitespace-nowrap font-medium">${t.symbol.toUpperCase()}</td><td class="px-6 py-4 whitespace-nowrap font-semibold ${typeColor[t.type]}">${typeText[t.type]}</td><td class="px-6 py-4 whitespace-nowrap">${formatNumber(t.quantity, decimals)}</td><td class="px-6 py-4 whitespace-nowrap">${formatNumber(t.price)} <span class="text-xs text-gray-500">${t.currency}</span></td><td class="px-6 py-4 whitespace-nowrap">${formatNumber(t.totalCostTWD, 0)}</td><td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium"><button data-id="${t.id}" class="edit-btn text-indigo-600 hover:text-indigo-900 mr-3">編輯</button><button data-id="${t.id}" class="delete-btn text-red-600 hover:text-red-900">刪除</button></td>`; tableBody.appendChild(row); }; document.querySelectorAll('.edit-btn').forEach(btn => btn.addEventListener('click', handleEdit)); document.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', handleDelete)); }
    function renderSplitsTable() { const tableBody = document.getElementById('splits-table-body'); tableBody.innerHTML = ''; if (userSplits.length === 0) { tableBody.innerHTML = `<tr><td colspan="4" class="text-center py-10 text-gray-500">沒有拆股事件。</td></tr>`; return; } for (const s of [...userSplits].reverse()) { const row = document.createElement('tr'); row.className = "hover:bg-gray-50"; const splitDate = s.date.toDate ? s.date.toDate().toISOString().split('T')[0] : s.date; row.innerHTML = `<td class="px-6 py-4 whitespace-nowrap">${splitDate}</td><td class="px-6 py-4 whitespace-nowrap font-medium">${s.symbol.toUpperCase()}</td><td class="px-6 py-4 whitespace-nowrap">${s.ratio}</td><td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium"><button data-id="${s.id}" class="delete-split-btn text-red-600 hover:text-red-900">刪除</button></td>`; tableBody.appendChild(row); } document.querySelectorAll('.delete-split-btn').forEach(btn => btn.addEventListener('click', handleDeleteSplit)); }
    function updateDashboard() { const holdingsArray = Object.values(holdings); const totalMarketValue = holdingsArray.reduce((sum, h) => sum + h.marketValueTWD, 0); const totalUnrealizedPL = holdingsArray.reduce((sum, h) => sum + h.unrealizedPLTWD, 0); document.getElementById('total-assets').textContent = formatNumber(totalMarketValue, 0); const unrealizedEl = document.getElementById('unrealized-pl'); unrealizedEl.textContent = formatNumber(totalUnrealizedPL, 0); unrealizedEl.className = `text-3xl font-bold mt-2 ${totalUnrealizedPL >= 0 ? 'text-red-600' : 'text-green-600'}`; const realizedEl = document.getElementById('realized-pl'); realizedEl.textContent = formatNumber(realizedPLFromBackend, 0); realizedEl.className = `text-3xl font-bold mt-2 ${realizedPLFromBackend >= 0 ? 'text-red-600' : 'text-green-600'}`; const totalReturnEl = document.getElementById('total-return'); totalReturnEl.textContent = `${overallReturnRateFromBackend.toFixed(2)}%`; totalReturnEl.className = `text-3xl font-bold mt-2 ${overallReturnRateFromBackend >= 0 ? 'text-red-600' : 'text-green-600'}`; const xirrEl = document.getElementById('xirr-value'); xirrEl.textContent = `${(xirrFromBackend * 100).toFixed(2)}%`; xirrEl.className = `text-3xl font-bold mt-2 ${xirrFromBackend >= 0 ? 'text-red-600' : 'text-green-600'}`; window.dispatchEvent(new Event('resize')); }
    async function handleFormSubmit(e) { e.preventDefault(); if (!userId) return; const id = document.getElementById('transaction-id').value; const transactionData = { date: new Date(document.getElementById('transaction-date').value), symbol: document.getElementById('stock-symbol').value.toUpperCase().trim(), type: document.querySelector('input[name="transaction-type"]:checked').value, quantity: parseFloat(document.getElementById('quantity').value), price: parseFloat(document.getElementById('price').value), currency: document.getElementById('currency').value, totalCostTWD: 0 }; if (transactionData.currency === 'USD') { transactionData.exchangeRate = parseFloat(document.getElementById('exchange-rate').value); if (isNaN(transactionData.exchangeRate)) { const rates = (await getDoc(doc(db, 'exchange_rates', 'TWD=X'))).data()?.rates; transactionData.exchangeRate = findNearestAvailableRate(rates, transactionData.date.toISOString().split('T')[0]); } } else { transactionData.exchangeRate = 1; } transactionData.totalCostTWD = transactionData.price * transactionData.quantity * transactionData.exchangeRate; const txCol = collection(db, 'users', userId, 'transactions'); if (id) { await updateDoc(doc(txCol, id), transactionData); } else { await addDoc(txCol, transactionData); } closeModal(); }
    async function handleSplitFormSubmit(e) { e.preventDefault(); if (!userId) return; const splitData = { date: new Date(document.getElementById('split-date').value), symbol: document.getElementById('split-symbol').value.toUpperCase().trim(), ratio: parseFloat(document.getElementById('split-ratio').value) }; const splitsCol = collection(db, 'users', userId, 'splits'); await addDoc(splitsCol, splitData); closeSplitModal(); }
    function handleEdit(e) { const id = e.target.dataset.id; const transaction = transactions.find(t => t.id === id); if (transaction) { openModal(true, transaction); } }
    async function handleDelete(e) { const id = e.target.dataset.id; await deleteDoc(doc(db, 'users', userId, 'transactions', id)); }
    async function handleDeleteSplit(e) { const id = e.target.dataset.id; await deleteDoc(doc(db, 'users', userId, 'splits', id)); }
    function openModal(isEdit = false, transaction = null) { const form = document.getElementById('transaction-form'); form.reset(); document.getElementById('transaction-id').value = ''; if (isEdit) { document.getElementById('modal-title').textContent = '編輯交易'; document.getElementById('transaction-id').value = transaction.id; document.getElementById('transaction-date').value = transaction.date.toDate().toISOString().split('T')[0]; document.getElementById('stock-symbol').value = transaction.symbol; document.querySelector(`input[name="transaction-type"][value="${transaction.type}"]`).checked = true; document.getElementById('quantity').value = transaction.quantity; document.getElementById('price').value = transaction.price; document.getElementById('currency').value = transaction.currency; document.getElementById('exchange-rate').value = transaction.exchangeRate || ''; } else { document.getElementById('modal-title').textContent = '新增交易'; } toggleOptionalFields(); document.getElementById('transaction-modal').classList.remove('hidden'); }
    function openSplitModal() { document.getElementById('split-form').reset(); document.getElementById('split-modal').classList.remove('hidden'); }
    function closeModal() { document.getElementById('transaction-modal').classList.add('hidden'); }
    function closeSplitModal() { document.getElementById('split-modal').classList.add('hidden'); }
    function hideConfirm() { confirmCallback = null; document.getElementById('confirm-modal').classList.add('hidden'); }
    function isTwStock(symbol) { return symbol.toUpperCase().endsWith('.TW') || symbol.toUpperCase().endsWith('.TWO'); }
    function formatNumber(value, decimals = 2) { const num = Number(value); if (isNaN(num)) return '0.00'; return num.toLocaleString('en-US', { minimumFractionDigits: decimals, maximumFractionDigits: decimals }); }
    function showNotification(type, message) { const area = document.getElementById('notification-area'); const color = type === 'success' ? 'bg-green-500' : (type === 'info' ? 'bg-blue-500' : 'bg-red-500'); const icon = type === 'success' ? 'check-circle' : (type === 'info' ? 'info' : 'alert-circle'); const notification = document.createElement('div'); notification.className = `flex items-center ${color} text-white text-sm font-bold px-4 py-3 rounded-md shadow-lg mb-2`; notification.innerHTML = `<i data-lucide="${icon}" class="w-5 h-5 mr-2"></i><p>${message}</p>`; area.appendChild(notification); lucide.createIcons({nodes: [notification.querySelector('i')]}); setTimeout(() => { notification.style.transition = 'opacity 0.5s ease'; notification.style.opacity = '0'; setTimeout(() => notification.remove(), 500); }, 5000); }
    function showConfirm(message, callback) { document.getElementById('confirm-message').textContent = message; confirmCallback = callback; document.getElementById('confirm-modal').classList.remove('hidden'); }
    function showLoadingError(title, message) { const loadingText = document.getElementById('loading-text'); loadingText.innerHTML = `<p class="text-red-600 font-bold">${title}</p><p class="mt-2">${message}</p>`; }
    function switchTab(tabName) { document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden')); document.getElementById(`${tabName}-tab`).classList.remove('hidden'); document.querySelectorAll('.tab-item').forEach(el => { el.classList.remove('border-indigo-500', 'text-indigo-600'); el.classList.add('border-transparent', 'text-gray-500'); }); document.querySelector(`[data-tab="${tabName}"]`).classList.add('border-indigo-500', 'text-indigo-600'); }
    function findNearestAvailableRate(history, targetDateStr) { if (!history || !targetDateStr) return null; let targetDate = new Date(targetDateStr); for(let i=0; i<7; i++) { const dStr = targetDate.toISOString().split('T')[0]; if (history[dStr]) return history[dStr]; targetDate.setDate(targetDate.getDate() - 1); } return null; }

</script>
</body>
</html>
