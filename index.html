<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>股票交易紀錄與資產分析系統 (最終修正版)</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- ApexCharts -->
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  <!-- Lucide Icons -->
  <script src="https://cdn.jsdelivr.net/npm/lucide@0.378.0/dist/umd/lucide.min.js"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap"
    rel="stylesheet"
  />
  <style>
    body {
      font-family: 'Inter', 'Noto Sans TC', sans-serif;
      background: #f0f2f5;
    }
    .card {
      background: #fff;
      border-radius: 0.75rem;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1),
        0 2px 4px -2px rgb(0 0 0 / 0.1);
      transition: 0.3s;
    }
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1),
        0 4px 6px -4px rgb(0 0 0 / 0.1);
    }
    .btn {
      transition: 0.2s;
    }
    .btn:hover {
      transform: scale(1.05);
    }
    .modal-backdrop {
      background: rgba(0, 0, 0, 0.5);
      transition: opacity 0.3s;
    }
    .optional-field {
      display: none;
    }
  </style>
</head>
<body class="text-gray-800">
  <div id="app" class="min-h-screen">
    <!-- ===== Header ====================================================== -->
    <header class="bg-white shadow-md sticky top-0 z-20">
      <div
        class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center"
      >
        <div class="flex items-center space-x-3">
          <i data-lucide="line-chart" class="text-indigo-600 h-8 w-8"></i>
          <h1 class="text-2xl font-bold text-gray-800">
            交易紀錄與資產分析 (最終修正版)
          </h1>
        </div>
        <div class="text-xs text-gray-500 text-right">
          <span id="auth-status">連線中…</span>
          <p id="user-id" class="truncate max-w-[150px] sm:max-w-xs"></p>
        </div>
      </div>
    </header>

    <!-- ===================== Dashboard Cards ============================ -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <div
        id="loading-overlay"
        class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-40"
      >
        <div class="flex flex-col items-center text-center p-4">
          <svg
            class="animate-spin h-10 w-10 text-indigo-600"
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
          >
            <circle
              class="opacity-25"
              cx="12"
              cy="12"
              r="10"
              stroke="currentColor"
              stroke-width="4"
            ></circle>
            <path
              class="opacity-75"
              fill="currentColor"
              d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
            ></path>
          </svg>
          <p id="loading-text" class="mt-4 text-lg font-medium text-gray-700">
            正在從雲端同步資料…
          </p>
        </div>
      </div>

      <div
        class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-6 mb-8"
      >
        <div class="card p-5">
          <div class="flex items-center justify-between">
            <h3 class="text-sm font-medium text-gray-500">總資產 (TWD)</h3>
            <i data-lucide="wallet" class="h-6 w-6 text-gray-400"></i>
          </div>
          <p id="total-assets" class="text-3xl font-bold mt-2">0</p>
        </div>

        <div class="card p-5">
          <div class="flex items-center justify-between">
            <h3 class="text-sm font-medium text-gray-500">未實現損益 (TWD)</h3>
            <i data-lucide="trending-up" class="h-6 w-6 text-gray-400"></i>
          </div>
          <p id="unrealized-pl" class="text-3xl font-bold mt-2">0</p>
        </div>

        <div class="card p-5">
          <div class="flex items-center justify-between">
            <h3 class="text-sm font-medium text-gray-500">已實現損益 (TWD)</h3>
            <i data-lucide="dollar-sign" class="h-6 w-6 text-gray-400"></i>
          </div>
          <p id="realized-pl" class="text-3xl font-bold mt-2">0</p>
        </div>

        <div class="card p-5">
          <div class="flex items-center justify-between">
            <h3 class="text-sm font-medium text-gray-500">總報酬率</h3>
            <i data-lucide="percent" class="h-6 w-6 text-gray-400"></i>
          </div>
          <p id="total-return" class="text-3xl font-bold mt-2">0.00%</p>
        </div>

        <div class="card p-5">
          <div class="flex items-center justify-between">
            <h3 class="text-sm font-medium text-gray-500">XIRR 年化報酬率</h3>
            <i data-lucide="calendar-check" class="h-6 w-6 text-gray-400"></i>
          </div>
          <p id="xirr-value" class="text-3xl font-bold mt-2">0.00%</p>
        </div>
      </div>

      <!-- 其餘「持股一覽 / 交易紀錄 / 拆股」表格與圖表 HTML
           完全沿用原檔，為節省版面此處省略 -->
    </main>
  </div>

  <!-- ================= Scripts ======================================== -->
  <script type="module">
    /* Firebase ---------------------------------------------------------------- */
    import {
      initializeApp,
      getApps,
      getApp
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getAuth,
      signInAnonymously,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import {
      getFirestore,
      collection,
      doc,
      addDoc,
      onSnapshot,
      updateDoc,
      deleteDoc,
      query,
      orderBy,
      serverTimestamp,
      getDoc
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    /* ---------- 依自己的 Firebase 專案填入 ---------- */
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_MSG_ID",
      appId: "YOUR_APP_ID"
    };
    /* ------------------------------------------------------------------ */

    /* ======== 全域狀態 ======== */
    let db, auth, userId;
    let transactions = [];
    let userSplits = [];
    let holdings = {};
    let realizedPLFromBackend = 0;
    let overallReturnRateFromBackend = 0;      // ★ 新增
    let chart;

    let dataLoaded = { transactions: false, holdings: false, splits: false };

    /* ================= 入口 ================= */
    document.addEventListener("DOMContentLoaded", init);

    function init() {
      const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
      auth = getAuth(app);
      db = getFirestore(app);

      initChart();
      lucide.createIcons();
      handleAuth();
    }

    function handleAuth() {
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          userId = user.uid;
          document.getElementById("auth-status").textContent = "已連線";
          document.getElementById("user-id").textContent =
            `使用者ID: ${userId.slice(0, 8)}…`;
          subscribeFirestore();
        } else {
          document.getElementById("auth-status").textContent = "嘗試匿名登入…";
          await signInAnonymously(auth);
        }
      });
    }

    /* ================= Firestore 監聽 ================= */
    function subscribeFirestore() {
      /* transactions */
      onSnapshot(
        query(collection(db, "users", userId, "transactions"),
              orderBy("date", "asc")),
        snap => {
          transactions = snap.docs.map(d => ({ id: d.id, ...d.data() }));
          dataLoaded.transactions = true;
          renderAll();
        });

      /* splits */
      onSnapshot(
        query(collection(db, "users", userId, "splits"),
              orderBy("date", "asc")),
        snap => {
          userSplits = snap.docs.map(d => ({ id: d.id, ...d.data() }));
          dataLoaded.splits = true;
          renderAll();
        });

      /* current_holdings  ← 讀取總報酬率 */
      onSnapshot(
        doc(db, "users", userId, "user_data", "current_holdings"),
        snap => {
          if (snap.exists()) {
            const d = snap.data();
            holdings = d.holdings || {};
            realizedPLFromBackend = d.totalRealizedPL || 0;
            overallReturnRateFromBackend =
              d.overallReturnRateTotal ?? d.overallReturnRate ?? 0;

            const xirr = d.xirr || 0;
            const xirrEl = document.getElementById("xirr-value");
            xirrEl.textContent = `${(xirr * 100).toFixed(2)}%`;
            xirrEl.className =
              `text-3xl font-bold mt-2 ${xirr >= 0 ? "text-red-600" : "text-green-600"}`;
          } else {
            holdings = {};
            realizedPLFromBackend = 0;
            overallReturnRateFromBackend = 0;
          }
          dataLoaded.holdings = true;
          renderAll();
        });
    }

    /* ================= 渲染 ================= */
    function renderAll() {
      if (!dataLoaded.transactions || !dataLoaded.holdings || !dataLoaded.splits)
        return;

      // 省略表格渲染函式…

      updateDashboard();
      document.getElementById("loading-overlay").style.display = "none";
    }

    /* ★★★★★ Dashboard Cards ★★★★★ */
    function updateDashboard() {
      const list = Object.values(holdings);
      const totalMV = list.reduce((s, h) => s + h.marketValueTWD, 0);
      const unrealPL = list.reduce((s, h) => s + h.unrealizedPLTWD, 0);

      document.getElementById("total-assets").textContent =
        numberFmt(totalMV, 0);

      const unrealEl = document.getElementById("unrealized-pl");
      unrealEl.textContent = numberFmt(unrealPL, 0);
      unrealEl.className =
        `text-3xl font-bold mt-2 ${unrealPL >= 0 ? "text-red-600" : "text-green-600"}`;

      const realizedEl = document.getElementById("realized-pl");
      realizedEl.textContent = numberFmt(realizedPLFromBackend, 0);
      realizedEl.className =
        `text-3xl font-bold mt-2 ${realizedPLFromBackend >= 0 ? "text-red-600" : "text-green-600"}`;

      /* 直接用後端算好的值 */
      const roi = overallReturnRateFromBackend;
      const roiEl = document.getElementById("total-return");
      roiEl.textContent = `${roi.toFixed(2)}%`;
      roiEl.className =
        `text-3xl font-bold mt-2 ${roi >= 0 ? "text-red-600" : "text-green-600"}`;
    }

    /* ================== 圖表 ================== */
    function initChart() {
      chart = new ApexCharts(document.querySelector("#asset-chart"), {
        chart: { type: "area", height: 350, toolbar: { show: true } },
        series: [{ name: "總資產", data: [] }],
        xaxis: { type: "datetime" },
        stroke: { curve: "smooth" },
        dataLabels: { enabled: false },
        colors: ["#4f46e5"]
      });
      chart.render();
    }

    /* ================== 工具 ================== */
    function numberFmt(v, d = 2) {
      const n = Number(v);
      return isNaN(n)
        ? "0"
        : n.toLocaleString("en-US", {
            minimumFractionDigits: d,
            maximumFractionDigits: d
          });
    }
  </script>
</body>
</html>
